------------------------------------------------------------
-- 1) Ensure language master rows exist
------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @EsCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@EsCode, N'Spanish');

IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @FrCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@FrCode, N'French');

------------------------------------------------------------
-- 2) Enable languages for the project (MRFLANGUAGE uses LanguageId)
------------------------------------------------------------
IF OBJECT_ID('dbo.MRFLANGUAGE', 'U') IS NOT NULL
BEGIN
    -- Enable Spanish
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @EsCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );

    -- Enable French
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @FrCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );
END



*******************************************************************************/* ======= CONFIG ======= */
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx';
DECLARE @Sheet     NVARCHAR(128)  = N'Sheet1$'; -- change if needed

/* ======= Prep: enable OPENROWSET if needed ======= */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* ======= Stage Excel ======= */
IF OBJECT_ID('tempdb..#xl_raw') IS NOT NULL DROP TABLE #xl_raw;
CREATE TABLE #xl_raw
(
  ProjectId INT           NOT NULL,
  FieldId   INT           NOT NULL,
  EsText    NVARCHAR(4000) NULL,
  FrText    NVARCHAR(4000) NULL
);

INSERT INTO #xl_raw(ProjectId, FieldId, EsText, FrText)
SELECT
  CAST([ProjectId] AS INT) AS ProjectId,
  CAST([FieldId]   AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [ProjectId],[FieldId],[es],[fr] FROM [' + @Sheet + ']'
) AS X;

-- De-dup per ProjectId+FieldId (take the longest non-null value if duplicates)
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
SELECT
  ProjectId,
  FieldId,
  EsText = (SELECT TOP(1) v FROM (SELECT EsText v UNION ALL SELECT EsText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC),
  FrText = (SELECT TOP(1) v FROM (SELECT FrText v UNION ALL SELECT FrText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC)
INTO #xl
FROM #xl_raw
GROUP BY ProjectId, FieldId;

/* ======= Resolve language ids ======= */
DECLARE @EsLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'es', N'es-ES') ORDER BY CASE WHEN LanguageCode=N'es' THEN 0 ELSE 1 END);
DECLARE @FrLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'fr', N'fr-FR') ORDER BY CASE WHEN LanguageCode=N'fr' THEN 0 ELSE 1 END);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish (es/es-ES) or French (fr/fr-FR) missing in LANGUAGE.', 16, 1);
  RETURN;
END

/* ======= Ensure MRFLANGUAGE rows exist for ALL ProjectIds in the sheet ======= */
-- Spanish
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @EsLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @EsLangId
);

-- French
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @FrLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @FrLangId
);

/* ======= UPSERT Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.EsText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @EsLangId
  WHERE x.EsText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

/* ======= UPSERT French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.FrText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @FrLangId
  WHERE x.FrText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

############################################################################################

/* ======= CONFIG ======= */
DECLARE @ProjectId INT = 123;  -- <-- set your project
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx'; -- full path
DECLARE @Sheet NVARCHAR(128) = N'Sheet1$';  -- worksheet name with trailing $

/* ======= Setup (OPENROWSET) ======= */
/* Require: ACE OLE DB and Ad Hoc Distributed Queries enabled */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* Temp staging */
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
CREATE TABLE #xl
(
  FieldId INT NOT NULL,
  EsText NVARCHAR(4000) NULL,
  FrText NVARCHAR(4000) NULL
);

/* Read Excel into #xl */
INSERT INTO #xl(FieldId, EsText, FrText)
SELECT
  CAST([FieldId] AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [FieldId], [es], [fr] FROM [' + @Sheet + ']'
) AS X;

/* Validate staging */
IF EXISTS (SELECT 1 FROM #xl WHERE FieldId IS NULL)
BEGIN
  RAISERROR('Staging contains NULL FieldId values. Fix the Excel file and retry.', 16, 1);
  RETURN;
END

/* ======= Resolve LanguageIds and MRFLanguageIds ======= */
DECLARE @EsLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'es', N'es-ES')
  ORDER BY CASE WHEN LanguageCode = N'es' THEN 0 ELSE 1 END
);
DECLARE @FrLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'fr', N'fr-FR')
  ORDER BY CASE WHEN LanguageCode = N'fr' THEN 0 ELSE 1 END
);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish or French not found in LANGUAGE table. Insert them first.', 16, 1);
  RETURN;
END

/* Ensure MRFLANGUAGE rows exist for this project */
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @EsLangId);
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @FrLangId);

DECLARE @EsMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId);
DECLARE @FrMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId);

/* ======= Upsert Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, EsText
  FROM #xl
  WHERE EsText IS NOT NULL
) AS S
ON T.MRFLanguageId = @EsMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.EsText
  THEN UPDATE SET T.LanguageResource = S.EsText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@EsMRF, S.FieldId, S.EsText);

/* ======= Upsert French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, FrText
  FROM #xl
  WHERE FrText IS NOT NULL
) AS S
ON T.MRFLanguageId = @FrMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.FrText
  THEN UPDATE SET T.LanguageResource = S.FrText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@FrMRF, S.FieldId, S.FrText);


