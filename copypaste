public class CustomFieldResourceViewModel
{
    public int ProjectId { get; set; }

    public int SelectedLanguageId { get; set; }
    public int SelectedFieldId { get; set; }
    public string LanguageResourceText { get; set; }

    public List<SelectListItem> Languages { get; set; } = new();
    public List<SelectListItem> CustomFields { get; set; } = new();

    // For listing existing mappings
    public List<CustomFieldResourceListItem> ExistingResources { get; set; } = new();

    public class CustomFieldResourceListItem
    {
        public int Id { get; set; }                  // MRFLanguageResource.Id
        public string LanguageName { get; set; }
        public string FieldName { get; set; }
        public string ResourceText { get; set; }
    }
}





using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Mvc.Rendering;
using YourApp.ViewModels;
using GoRegister.ApplicationCore.Data;

public class CustomFieldResourceService : ICustomFieldResourceService
{
    private readonly ApplicationDbContext _db;

    public CustomFieldResourceService(ApplicationDbContext db)
    {
        _db = db;
    }

    // ------------------------------------------------------
    // LOAD PAGE DATA (Languages, Fields, Existing Resources)
    // ------------------------------------------------------
    public async Task<CustomFieldResourceViewModel> LoadPageAsync(int projectId)
    {
        var vm = new CustomFieldResourceViewModel
        {
            ProjectId = projectId
        };

        // 1. Languages mapped to this project (MRFLanguage)
        vm.Languages = await (
            from ml in _db.MRFLanguage
            join l in _db.Language on ml.LanguageId equals l.Id
            where ml.ProjectId == projectId
            orderby l.SortOrder
            select new SelectListItem
            {
                Value = l.Id.ToString(),
                Text = l.LanguageName
            }
        ).ToListAsync();


        // 2. Custom Fields (where IsStandardField == null)
        vm.CustomFields = await _db.Fields
            .Where(f => f.ProjectId == projectId && f.IsStandardField == null)
            .OrderBy(f => f.SortOrder)
            .Select(f => new SelectListItem
            {
                Value = f.Id.ToString(),
                Text = f.FieldName ?? f.DataTag
            })
            .ToListAsync();


        // 3. Existing Translations
        vm.ExistingResources = await (
            from mr in _db.MRFLanguageResource
            join lr in _db.LanguageResource on mr.LanguageResourceId equals lr.Id
            join f in _db.Fields on mr.FieldId equals f.Id
            join l in _db.Language on lr.LanguageId equals l.Id
            where mr.ProjectId == projectId
            select new CustomFieldResourceViewModel.CustomFieldResourceListItem
            {
                Id = mr.Id,
                LanguageName = l.LanguageName,
                FieldName = f.FieldName ?? f.DataTag,
                ResourceText = lr.LanguageResourceText
            }
        ).ToListAsync();

        return vm;
    }

    // ------------------------------------------------------
    // SAVE A NEW RESOURCE
    // ------------------------------------------------------
    public async Task SaveAsync(CustomFieldResourceViewModel vm)
    {
        // Save into LanguageResource
        var lr = new LanguageResource
        {
            LanguageId = vm.SelectedLanguageId,
            LanguageResourceText = vm.LanguageResourceText,
            ProjectId = vm.ProjectId,
            StandardField = false
        };

        _db.LanguageResource.Add(lr);
        await _db.SaveChangesAsync();

        // Link to MRFLanguageResource
        var mrlr = new MRFLanguageResource
        {
            ProjectId = vm.ProjectId,
            FieldId = vm.SelectedFieldId,
            LanguageResourceId = lr.Id
        };

        _db.MRFLanguageResource.Add(mrlr);
        await _db.SaveChangesAsync();
    }

    // ------------------------------------------------------
    // DELETE RESOURCE (remove both tables)
    // ------------------------------------------------------
    public async Task DeleteAsync(int id, int projectId)
    {
        var mr = await _db.MRFLanguageResource.FindAsync(id);

        if (mr != null)
        {
            var lr = await _db.LanguageResource.FindAsync(mr.LanguageResourceId);
            if (lr != null) _db.LanguageResource.Remove(lr);

            _db.MRFLanguageResource.Remove(mr);
            await _db.SaveChangesAsync();
        }
    }
}








public async Task<Dictionary<string, string>> GetLabelMapForLanguageAsync(int projectId, string languageCode)
{
    var rows = await (
        from l in _db.Language
        join mrl in _db.MRFLanguage on l.Id equals mrl.LanguageId
        join lr in _db.LanguageResource on new { mrl.ProjectId, mrl.LanguageId } 
                                           equals new { lr.ProjectId, lr.LanguageId }
        join mrflr in _db.MRFLanguageResource on lr.Id equals mrflr.LanguageResourceId
        join f in _db.Fields on mrflr.FieldId equals f.Id
        where mrl.ProjectId == projectId
           && l.LanguageCode.ToLower() == languageCode.ToLower()
        select new
        {
            FieldKey = f.Id.ToString(),
            Label = lr.LanguageResourceText
        }
    ).ToListAsync();

    return rows
        .GroupBy(x => x.FieldKey)
        .ToDictionary(g => g.Key, g => g.First().Label);
}


public async Task<Dictionary<string, string>> GetLabelMapForLanguageAsync(int projectId, string languageCode)
{
    var rows = await (
        from lr in _db.LanguageResource
		join l in _db.Language on lr.LanguageId equals l.Id
        join mrflr in _db.MRFLanguageResource on lr.Id equals mrflr.LanguageResourceId
		join f in _db.Fields on mrflr.FieldId equals f.Id
		where l.LanguageCode.ToLower() == languageCode.ToLower() && lr.ProjectId == projectId
		select new
        {
            FieldKey = f.Id.ToString(), 
            Label = lr.LanguageResourceText                    
        }
    ).ToListAsync();

    var map = rows
        .GroupBy(x => x.FieldKey)
        .ToDictionary(g => g.Key, g => g.First().Label);

    return map;
}

SELECT * FROM LANGUAGE
SELECT * FROM MRFLANGUAGE
SELECT * FROM LANGUAGERESOURCE
SELECT * FROM MRFLANGUAGERESOURCE

7	English	en	1	1
8	Spanish	es	1	2
9	French	fr	1	3

1	112	8
2	112	9
3	112	7

1	*Event Start Date 	9	1	112	EventStartDate
2	*Event End Date 	9	1	112	EventEndDate
3	*Contact email address	9	1	112	Email
4	*Destination 	9	1	112	DestinationExternalId
5	*Requestor Country	9	1	112	RequestorCountry
6	*Servicing Country	9	1	112	ServicingCountry
7	*Contact First Name	9	1	112	FirstName
8	*Contact Last Name	9	1	112	LastName
9	*Are your dates or destination flexible? 	9	1	112	Areyourdatesordestinationflexible?
10	Additional Information	9	1	112	AdditionalInformation
11	*Contact phone number	9	1	112	Contactphonenumber
12	Event Name 	9	1	112	EventName
13	*Number of Attendees 	9	1	112	NumberofAttendees

1	112	3167	1
2	112	3168	2
3	112	3169	3
4	112	3172	4
5	112	3173	5
6	112	3174	6
7	112	3175	7
8	112	3184	8
9	112	3187	9
10	112	3192	10
11	112	3194	11
12	112	3195	12
13	112	3196	13

=============================================================================================================================================


CREATE OR ALTER PROCEDURE dbo.ImportLanguageResources
(
      @LanguageCode NVARCHAR(10)     -- 'fr', 'es', or 'en'
    , @ExcelPath    NVARCHAR(4000)   -- Full file path
)
AS
BEGIN
    SET NOCOUNT ON;
    SET XACT_ABORT ON;

    DECLARE 
          @LanguageId INT
        , @ProjectId INT
        , @ResourceColumn NVARCHAR(50)
        , @sql NVARCHAR(MAX);

    PRINT 'Starting import for LanguageCode = ' + @LanguageCode;

    ------------------------------------------------------------
    -- 1. Validate & Look Up LanguageId
    ------------------------------------------------------------
    SELECT @LanguageId = Id 
    FROM Language 
    WHERE LanguageCode = @LanguageCode;

    IF @LanguageId IS NULL
    BEGIN
        RAISERROR('LanguageCode "%s" not found in Language table.', 16, 1, @LanguageCode);
        RETURN;
    END

    ------------------------------------------------------------
    -- 2. Look up ProjectId for this language
    -- A language can be used in multiple projects, but here we
    -- pick the first one. Adjust if needed.
    ------------------------------------------------------------
    SELECT TOP 1 @ProjectId = ProjectId 
    FROM MRFLANGUAGE
    WHERE LanguageId = @LanguageId;

    IF @ProjectId IS NULL
    BEGIN
        RAISERROR('No MRFLANGUAGE record found for LanguageId %d.', 16, 1, @LanguageId);
        RETURN;
    END

    ------------------------------------------------------------
    -- 3. Determine which column to read from Excel
    ------------------------------------------------------------
    IF (@LanguageCode = 'fr')      SET @ResourceColumn = 'French';
    ELSE IF (@LanguageCode = 'es') SET @ResourceColumn = 'Spanish';
    ELSE IF (@LanguageCode = 'en') SET @ResourceColumn = 'FieldName';
    ELSE
    BEGIN
        RAISERROR('Unsupported LanguageCode "%s".', 16, 1, @LanguageCode);
        RETURN;
    END

    ------------------------------------------------------------
    -- 4. Load Excel → #ExcelResources using OPENROWSET
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#ExcelResources') IS NOT NULL DROP TABLE #ExcelResources;

    DECLARE @OpenRowset NVARCHAR(MAX) = '
        SELECT *
        FROM OPENROWSET(
            ''Microsoft.ACE.OLEDB.12.0'',
            ''Excel 12.0;HDR=YES;Database=' + @ExcelPath + ''',
            ''SELECT * FROM [Sheet1$]''
        )';

    CREATE TABLE #ExcelResources
    (
          FieldId INT
        , DataTag NVARCHAR(200)
        , French NVARCHAR(4000) NULL
        , Spanish NVARCHAR(4000) NULL
        , FieldName NVARCHAR(4000) NULL
    );

    INSERT INTO #ExcelResources
    EXEC(@OpenRowset);

    PRINT 'Excel loaded successfully.';

    ------------------------------------------------------------
    -- 5. Prepare #ToInsert (created OUTSIDE dynamic SQL)
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#ToInsert') IS NOT NULL DROP TABLE #ToInsert;

    CREATE TABLE #ToInsert
    (
          RowNum INT
        , FieldId INT
        , ResourceText NVARCHAR(4000)
        , DataTag NVARCHAR(200)
    );

    ------------------------------------------------------------
    -- 6. Insert rows into #ToInsert via dynamic SQL
    -- This works because table exists *before* EXEC.
    ------------------------------------------------------------
    SET @sql = N'
        INSERT INTO #ToInsert (RowNum, FieldId, ResourceText, DataTag)
        SELECT
              ROW_NUMBER() OVER (ORDER BY FieldId) AS RowNum
            , FieldId
            , ' + QUOTENAME(@ResourceColumn) + N' AS ResourceText
            , DataTag
        FROM #ExcelResources
        WHERE ' + QUOTENAME(@ResourceColumn) + N' IS NOT NULL
          AND LTRIM(RTRIM(' + QUOTENAME(@ResourceColumn) + N')) <> ''''
    ';

    EXEC(@sql);

    PRINT 'Rows staged into #ToInsert.';

    ------------------------------------------------------------
    -- 7. Prepare #InsertedResources to capture mapping
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#InsertedResources') IS NOT NULL DROP TABLE #InsertedResources;

    CREATE TABLE #InsertedResources
    (
          RowNum INT
        , LanguageResourceId INT
    );

    ------------------------------------------------------------
    -- 8. MERGE to insert into LanguageResource and capture IDs
    ------------------------------------------------------------
    MERGE INTO LanguageResource AS T
    USING (
        SELECT
              RowNum
            , ResourceText
            , @LanguageId AS LanguageId
            , 1 AS StandardField
            , @ProjectId AS ProjectId
            , DataTag
        FROM #ToInsert
    ) AS SRC
        ON 1 = 0   -- Always insert
    WHEN NOT MATCHED THEN
        INSERT (LanguageResourceText, LanguageId, StandardField, ProjectId, DataTag)
        VALUES (SRC.ResourceText, SRC.LanguageId, SRC.StandardField, SRC.ProjectId, SRC.DataTag)
    OUTPUT 
          SRC.RowNum
        , INSERTED.Id
    INTO #InsertedResources (RowNum, LanguageResourceId);

    PRINT 'Inserted into LanguageResource.';

    ------------------------------------------------------------
    -- 9. Insert into MRFLanguageResource (Field ↔ Resource)
    ------------------------------------------------------------
    INSERT INTO MRFLanguageResource (ProjectId, FieldId, LanguageResourceId)
    SELECT
          @ProjectId
        , T.FieldId
        , IR.LanguageResourceId
    FROM #ToInsert AS T
    JOIN #InsertedResources AS IR
        ON T.RowNum = IR.RowNum;

    PRINT 'Linked fields to LanguageResource';

    ------------------------------------------------------------
    -- 10. Cleanup
    ------------------------------------------------------------
    DROP TABLE #InsertedResources;
    DROP TABLE #ToInsert;
    DROP TABLE #ExcelResources;

    PRINT 'Import completed successfully for ' + @LanguageCode;

END
GO




************************************************************************************************************************************************






------------------------------------------------------------
-- 1) Ensure language master rows exist
------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @EsCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@EsCode, N'Spanish');

IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @FrCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@FrCode, N'French');

------------------------------------------------------------
-- 2) Enable languages for the project (MRFLANGUAGE uses LanguageId)
------------------------------------------------------------
IF OBJECT_ID('dbo.MRFLANGUAGE', 'U') IS NOT NULL
BEGIN
    -- Enable Spanish
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @EsCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );

    -- Enable French
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @FrCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );
END



*******************************************************************************/* ======= CONFIG ======= */
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx';
DECLARE @Sheet     NVARCHAR(128)  = N'Sheet1$'; -- change if needed

/* ======= Prep: enable OPENROWSET if needed ======= */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* ======= Stage Excel ======= */
IF OBJECT_ID('tempdb..#xl_raw') IS NOT NULL DROP TABLE #xl_raw;
CREATE TABLE #xl_raw
(
  ProjectId INT           NOT NULL,
  FieldId   INT           NOT NULL,
  EsText    NVARCHAR(4000) NULL,
  FrText    NVARCHAR(4000) NULL
);

INSERT INTO #xl_raw(ProjectId, FieldId, EsText, FrText)
SELECT
  CAST([ProjectId] AS INT) AS ProjectId,
  CAST([FieldId]   AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [ProjectId],[FieldId],[es],[fr] FROM [' + @Sheet + ']'
) AS X;

-- De-dup per ProjectId+FieldId (take the longest non-null value if duplicates)
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
SELECT
  ProjectId,
  FieldId,
  EsText = (SELECT TOP(1) v FROM (SELECT EsText v UNION ALL SELECT EsText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC),
  FrText = (SELECT TOP(1) v FROM (SELECT FrText v UNION ALL SELECT FrText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC)
INTO #xl
FROM #xl_raw
GROUP BY ProjectId, FieldId;

/* ======= Resolve language ids ======= */
DECLARE @EsLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'es', N'es-ES') ORDER BY CASE WHEN LanguageCode=N'es' THEN 0 ELSE 1 END);
DECLARE @FrLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'fr', N'fr-FR') ORDER BY CASE WHEN LanguageCode=N'fr' THEN 0 ELSE 1 END);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish (es/es-ES) or French (fr/fr-FR) missing in LANGUAGE.', 16, 1);
  RETURN;
END

/* ======= Ensure MRFLANGUAGE rows exist for ALL ProjectIds in the sheet ======= */
-- Spanish
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @EsLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @EsLangId
);

-- French
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @FrLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @FrLangId
);

/* ======= UPSERT Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.EsText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @EsLangId
  WHERE x.EsText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

/* ======= UPSERT French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.FrText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @FrLangId
  WHERE x.FrText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

############################################################################################

/* ======= CONFIG ======= */
DECLARE @ProjectId INT = 123;  -- <-- set your project
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx'; -- full path
DECLARE @Sheet NVARCHAR(128) = N'Sheet1$';  -- worksheet name with trailing $

/* ======= Setup (OPENROWSET) ======= */
/* Require: ACE OLE DB and Ad Hoc Distributed Queries enabled */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* Temp staging */
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
CREATE TABLE #xl
(
  FieldId INT NOT NULL,
  EsText NVARCHAR(4000) NULL,
  FrText NVARCHAR(4000) NULL
);

/* Read Excel into #xl */
INSERT INTO #xl(FieldId, EsText, FrText)
SELECT
  CAST([FieldId] AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [FieldId], [es], [fr] FROM [' + @Sheet + ']'
) AS X;

/* Validate staging */
IF EXISTS (SELECT 1 FROM #xl WHERE FieldId IS NULL)
BEGIN
  RAISERROR('Staging contains NULL FieldId values. Fix the Excel file and retry.', 16, 1);
  RETURN;
END

/* ======= Resolve LanguageIds and MRFLanguageIds ======= */
DECLARE @EsLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'es', N'es-ES')
  ORDER BY CASE WHEN LanguageCode = N'es' THEN 0 ELSE 1 END
);
DECLARE @FrLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'fr', N'fr-FR')
  ORDER BY CASE WHEN LanguageCode = N'fr' THEN 0 ELSE 1 END
);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish or French not found in LANGUAGE table. Insert them first.', 16, 1);
  RETURN;
END

/* Ensure MRFLANGUAGE rows exist for this project */
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @EsLangId);
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @FrLangId);

DECLARE @EsMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId);
DECLARE @FrMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId);

/* ======= Upsert Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, EsText
  FROM #xl
  WHERE EsText IS NOT NULL
) AS S
ON T.MRFLanguageId = @EsMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.EsText
  THEN UPDATE SET T.LanguageResource = S.EsText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@EsMRF, S.FieldId, S.EsText);

/* ======= Upsert French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, FrText
  FROM #xl
  WHERE FrText IS NOT NULL
) AS S
ON T.MRFLanguageId = @FrMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.FrText
  THEN UPDATE SET T.LanguageResource = S.FrText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@FrMRF, S.FieldId, S.FrText);


