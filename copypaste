
public async Task DeleteAsync(int projectId, int languageId)
{
    // Soft delete from MRFLanguage
    var mrfLanguage = await _db.MRFLanguage
        .FirstOrDefaultAsync(x => x.ProjectId == projectId && x.LanguageId == languageId);

    if (mrfLanguage != null)
    {
        mrfLanguage.IsActive = false;
    }

    // STEP 1: Get all LanguageResource rows for THIS languageId
    var langResourceIds = await _db.LanguageResource
        .Where(lr => lr.LanguageId == languageId)
        .Select(lr => lr.Id)
        .ToListAsync();

    if (langResourceIds.Any())
    {
        // STEP 2: Soft delete MRFLanguageResource rows based on LanguageResourceId
        var mrfLangResources = await _db.MRFLanguageResource
            .Where(m => m.ProjectId == projectId
                     && langResourceIds.Contains(m.LanguageResourceId))
            .ToListAsync();

        foreach (var res in mrfLangResources)
        {
            res.IsActive = false;
        }
    }

    await _db.SaveChangesAsync();
}



public class LanguageMappingViewModel
{
    // ADD MODE – Multi-select
    public List<int> SelectedLanguageIds { get; set; } = new();

    // EDIT MODE – Single language
    public int SelectedLanguageId { get; set; }

    // Hidden key for Edit mode
    public int LanguageId { get; set; }

    public bool IsActive { get; set; } = true;

    public string AddEdit { get; set; } = "Add";

    // Dropdown list
    public List<SelectListItem> Languages { get; set; } = new();

    // Table/grid list
    public List<LanguageMappingGridItem> ExistingLanguages { get; set; } = new();

    public string Message { get; set; }
}

public class LanguageMappingGridItem
{
    public int LanguageId { get; set; }
    public string LanguageName { get; set; }
    public bool IsActive { get; set; }
}



service
-------

public async Task<LanguageMappingViewModel> LoadPageAsync(int projectId)
{
    var vm = new LanguageMappingViewModel();

    // Load dropdown languages (ACTIVE languages only)
    vm.Languages = await _db.Language
        .Where(l => l.IsActive)
        .Select(l => new SelectListItem
        {
            Value = l.Id.ToString(),
            Text = l.LanguageName
        }).ToListAsync();

    // Load existing MRFLanguage grid
    vm.ExistingLanguages = await _db.MRFLanguage
        .Where(x => x.ProjectId == projectId && x.IsActive)
        .Select(x => new LanguageMappingGridItem
        {
            LanguageId = x.LanguageId,
            LanguageName = x.Language.LanguageName,
            IsActive = x.IsActive
        })
        .ToListAsync();

    return vm;
}


public async Task<(bool success, string message)> SaveAsync(int projectId, LanguageMappingViewModel vm)
{
    var existingLangs = await _db.MRFLanguage
        .Where(x => x.ProjectId == projectId)
        .Select(x => x.LanguageId)
        .ToListAsync();

    var newLanguages = vm.SelectedLanguageIds
        .Where(id => !existingLangs.Contains(id))
        .ToList();

    if (!newLanguages.Any())
        return (false, "Selected language(s) already exist.");

    foreach (var langId in newLanguages)
    {
        // Insert MRFLanguage
        var mrfLang = new MRFLanguage
        {
            ProjectId = projectId,
            LanguageId = langId,
            IsActive = true
        };
        _db.MRFLanguage.Add(mrfLang);

        // Create MRFLanguageResource entries
        await CreateLanguageResourceRowsAsync(projectId, langId);
    }

    await _db.SaveChangesAsync();
    return (true, "Language(s) added successfully.");
}


-----------------------------------------------------------------------------------

private async Task CreateLanguageResourceRowsAsync(int projectId, int languageId)
{
    var languageResources = await _db.LanguageResource
        .Where(lr => lr.LanguageId == languageId)
        .ToListAsync();

    var projectFields = await _db.Fields
        .Where(f => f.ProjectId == projectId)
        .ToListAsync();

    foreach (var lr in languageResources)
    {
        var field = projectFields.FirstOrDefault(f =>
            f.DataTag != null &&
            f.DataTag.ToLower() == lr.DataTag.ToLower());

        if (field == null)
            continue;

        _db.MRFLanguageResource.Add(new MRFLanguageResource
        {
            ProjectId = projectId,
            FieldId = field.Id,
            LanguageResourceId = lr.Id,
            LanguageId = languageId,
            IsActive = true
        });
    }
}

-----------------------------------------------------------------------------------------


public async Task<LanguageMappingViewModel> LoadForEditAsync(int projectId, int langId)
{
    var mrfLanguage = await _db.MRFLanguage
        .FirstOrDefaultAsync(x => x.ProjectId == projectId && x.LanguageId == langId);

    if (mrfLanguage == null)
        return null;

    var vm = await LoadPageAsync(projectId);

    vm.AddEdit = "Edit";
    vm.LanguageId = langId;
    vm.SelectedLanguageId = langId;
    vm.IsActive = mrfLanguage.IsActive;

    return vm;
}


---------------------------------------------------

public async Task UpdateAsync(int projectId, LanguageMappingViewModel vm)
{
    var lang = await _db.MRFLanguage
        .FirstAsync(x => x.ProjectId == projectId && x.LanguageId == vm.SelectedLanguageId);

    lang.IsActive = vm.IsActive;

    // Update MRFLanguageResource
    var resources = await _db.MRFLanguageResource
        .Where(x => x.ProjectId == projectId && x.LanguageId == vm.SelectedLanguageId)
        .ToListAsync();

    foreach (var r in resources)
        r.IsActive = vm.IsActive;

    await _db.SaveChangesAsync();
}

-----------------------------------------------------

public async Task DeleteAsync(int projectId, int languageId)
{
    var lang = await _db.MRFLanguage
        .FirstAsync(x => x.ProjectId == projectId && x.LanguageId == languageId);

    lang.IsActive = false;

    var res = await _db.MRFLanguageResource
        .Where(x => x.ProjectId == projectId && x.LanguageId == languageId)
        .ToListAsync();

    foreach (var r in res)
        r.IsActive = false;

    await _db.SaveChangesAsync();
}

----------------------------------------------

Controller
==========

public class LanguageMappingController : ProjectAdminControllerBase
{
    private readonly IServiceLanguageMappingService _service;
    private readonly ISettingsService _settings;

    public LanguageMappingController(IServiceLanguageMappingService service, ISettingsService settings)
    {
        _service = service;
        _settings = settings;
    }

    private async Task<int> GetProjectIdAsync()
    {
        var settings = await _settings.GetSettingsAsync<GeneralSettingsModel>();
        return settings.Id;
    }

    // PAGE LOAD
    [HttpGet]
    public async Task<IActionResult> AddLanguage()
    {
        int projectId = await GetProjectIdAsync();
        var vm = await _service.LoadPageAsync(projectId);
        return View(vm);
    }

    // SAVE (Add + Edit)
    [HttpPost]
    public async Task<IActionResult> AddLanguage(LanguageMappingViewModel vm)
    {
        int projectId = await GetProjectIdAsync();

        if (vm.AddEdit == "Edit")
        {
            await _service.UpdateAsync(projectId, vm);

            vm.Message = "Language updated successfully.";
            return View(await _service.LoadPageAsync(projectId));
        }

        var result = await _service.SaveAsync(projectId, vm);
        vm.Message = result.message;

        return View(await _service.LoadPageAsync(projectId));
    }

    // EDIT
    [HttpGet]
    public async Task<IActionResult> Edit(int projectId, int langId)
    {
        var vm = await _service.LoadForEditAsync(projectId, langId);
        return View("AddLanguage", vm);
    }

    // DELETE (Soft delete)
    [HttpPost]
    public async Task<IActionResult> Delete(int projectId, int langId)
    {
        await _service.DeleteAsync(projectId, langId);
        return RedirectToAction(nameof(AddLanguage));
    }
}


html
======
@model LanguageMappingViewModel

<h2>MRF Language Mapping</h2>

@if (!string.IsNullOrWhiteSpace(Model.Message))
{
    <div class="alert alert-info">@Model.Message</div>
}

<form method="post">

    <input type="hidden" asp-for="LanguageId" />
    <input type="hidden" asp-for="AddEdit" />

    <div class="row">

        <div class="col-md-4">
            <label>Select Language(s)</label>

            @* ADD MODE *@
            @if (Model.AddEdit == "Add")
            {
                <select asp-for="SelectedLanguageIds"
                        asp-items="Model.Languages"
                        class="form-control"
                        multiple>
                </select>
            }

            @* EDIT MODE *@
            else
            {
                <select asp-for="SelectedLanguageId"
                        asp-items="Model.Languages"
                        class="form-control"
                        disabled>
                </select>
            }
        </div>

        <div class="col-md-4">
            <label>Is Active</label>
            <select asp-for="IsActive" class="form-control">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>

    </div>

    <button type="submit" class="btn btn-success mt-3">
        @(Model.AddEdit == "Edit" ? "Update" : "Save")
    </button>

    <a href="@Url.Action("AddLanguage")"
       class="btn btn-secondary mt-3">Clear</a>

</form>

<hr />

<h3>Mapped Languages</h3>

<table class="table table-hover table-bordered">
    <thead class="table-dark">
    <tr>
        <th>Language</th>
        <th>IsActive</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>

    <tbody>
    @foreach (var item in Model.ExistingLanguages)
    {
        <tr>
            <td>@item.LanguageName</td>
            <td>@(item.IsActive ? "Active" : "Inactive")</td>

            <td>
                <form method="get" asp-action="Edit"
                      asp-route-projectId="@ViewBag.ProjectId"
                      asp-route-langId="@item.LanguageId">
                    <button class="btn btn-primary btn-sm">Edit</button>
                </form>
            </td>

            <td>
                <form method="post" asp-action="Delete"
                      asp-route-projectId="@ViewBag.ProjectId"
                      asp-route-langId="@item.LanguageId">
                    <button class="btn btn-danger btn-sm">Delete</button>
                </form>
            </td>
        </tr>
    }
    </tbody>
</table>











*******************************************************************************************************************************************************************


@using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping
@model GoRegister.ApplicationCore.Domain.ServiceLanguageMapping.ServiceLanguageMappingModel

<h2>MRF Language Mapping</h2>

@if (!string.IsNullOrWhiteSpace(ViewBag.Smessage))
{
    <div class="alert alert-info">@ViewBag.Smessage</div>
}

<form method="post" asp-action="AddLanguage">
    <input type="hidden" asp-for="LanguageId" />
    <input type="hidden" asp-for="AddEdit" />

    <div class="row">

        <div class="col-md-4">
            <label>Select Language</label>
            <select id="LanguageSelect" class="form-control"
                    name="SelectedLanguageId"
                    @(Model.AddEdit == "Edit" ? "disabled" : "")>
                <option value="">-- choose --</option>

                @foreach (var l in ViewBag.LanguageList)
                {
                    <option value="@l.Value"
                            @(Model.LanguageId == int.Parse(l.Value) ? "selected" : "")>
                        @l.Text
                    </option>
                }
            </select>
        </div>

        <div class="col-md-4">
            <label>Is Active</label>
            <select asp-for="IsActive" class="form-control">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>

    </div>

    <button class="btn btn-success mt-3" type="submit">
        @(Model.AddEdit == "Edit" ? "Update" : "Save")
    </button>

    <a href="@Url.Action("AddLanguage", "LanguageMapping")" class="btn btn-secondary mt-3">
        Clear
    </a>
</form>

<hr />

<h3>Mapped Languages</h3>

<table class="table table-hover table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Language</th>
            <th>IsActive</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var item in ViewBag.ServiceLanguageMappingList as List<ServiceLanguageMappingModel>)
        {
            <tr>
                <td>@item.RequestLanguage</td>
                <td>@(item.IsActive ? "Active" : "Inactive")</td>

                <td>
                    <form method="get"
                          asp-action="Edit"
                          asp-route-projectId="@ViewBag.ProjectId"
                          asp-route-langId="@item.LanguageId">
                        <button class="btn btn-primary btn-sm">Edit</button>
                    </form>
                </td>

                <td>
                    <form method="post"
                          asp-action="Delete"
                          asp-route-projectId="@ViewBag.ProjectId"
                          asp-route-langId="@item.LanguageId">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>

            </tr>
        }
    </tbody>
</table>

using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.Areas.Admin.Controllers;
using Microsoft.AspNetCore.Mvc;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.LanguageMapping
{
    public class LanguageMappingController : ProjectAdminControllerBase
    {
        private readonly IServiceLanguageMappingService _languageMappingService;
        private readonly ISettingsService _settingsService;
        private readonly IClientService _clientservice;

        public static int ProjectId { get; set; }

        public LanguageMappingController(
            IServiceLanguageMappingService languageMappingService,
            ISettingsService settingsService,
            IClientService clientService)
        {
            _languageMappingService = languageMappingService;
            _settingsService = settingsService;
            _clientservice = clientService;
        }

        // LOAD PAGE
        [HttpGet]
        public async Task<IActionResult> AddLanguage()
        {
            await LoadProjectAndLists();
            return View(new ServiceLanguageMappingModel { AddEdit = "Add", IsActive = true });
        }

        // SAVE + UPDATE
        [HttpPost]
        public async Task<IActionResult> AddLanguage(ServiceLanguageMappingModel model)
        {
            await LoadProjectAndLists();

            // ------------------- UPDATE MODE -------------------
            if (model.AddEdit == "Edit")
            {
                await _languageMappingService.UpdateMRFLanguage(ProjectId, model.LanguageId, model.IsActive);

                ViewBag.Smessage = "Language updated successfully.";

                return View(model);
            }

            // ------------------- CREATE MODE -------------------
            if (model.SelectedLanguageId <= 0)
            {
                ViewBag.Smessage = "Please select a language.";
                return View(model);
            }

            int languageId = model.SelectedLanguageId;

            var existing = await _languageMappingService.GetList(ProjectId);

            if (existing.Any(x => x.LanguageId == languageId))
            {
                ViewBag.Smessage = "This language already exists.";
                return View(model);
            }

            var dto = new MRFLanguage
            {
                ProjectId = ProjectId,
                LanguageId = languageId,
                IsActive = model.IsActive
            };

            await _languageMappingService.CreateMRFLanguage(new[] { dto });
            await _languageMappingService.CreateMRFLanguageResource(new[] { dto });

            ViewBag.Smessage = "Language added successfully.";

            return RedirectToAction(nameof(AddLanguage));
        }

        // LOAD FOR EDIT
        [HttpGet]
        public async Task<IActionResult> Edit(int projectId, int langId)
        {
            await LoadProjectAndLists();

            var item = await _languageMappingService.GetItem(projectId, langId);

            if (item == null)
                return NotFound();

            var vm = new ServiceLanguageMappingModel
            {
                AddEdit = "Edit",
                LanguageId = item.LanguageId,
                SelectedLanguageId = item.LanguageId,
                IsActive = item.IsActive
            };

            return View(nameof(AddLanguage), vm);
        }

        // DELETE
        [HttpPost]
        public async Task<IActionResult> Delete(int projectId, int langId)
        {
            await _languageMappingService.DeleteMRFLanguage(projectId, langId);
            await _languageMappingService.DeleteMRFLanguageResource(projectId, langId);

            return RedirectToAction(nameof(AddLanguage));
        }

        private async Task LoadProjectAndLists()
        {
            var project = await _settingsService.GetSettingsAsync<GeneralSettingsModel>();
            ProjectId = project.Id;

            ViewBag.ProjectId = ProjectId;
            ViewBag.LanguageList = await _languageMappingService.LoadRequestLanguages();
            ViewBag.ServiceLanguageMappingList = await _languageMappingService.GetList(ProjectId);
        }
    }
}


++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

using GoRegister.ApplicationCore.Data.Models;
using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.Areas.Admin.Controllers;
using Microsoft.AspNetCore.Mvc;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace GoRegister.Areas.Admin.Features.LanguageMapping
{
	public class LanguageMappingController : ProjectAdminControllerBase
	{
		private readonly IServiceLanguageMappingService _languageMappingService;
		private readonly ISettingsService _settingsService;
		private readonly IClientService _clientservice;

		public static int ProjectId { get; set; }
		public static string ClientUuid { get; set; }
		public static int UserId { get; set; }

		public LanguageMappingController(
			IServiceLanguageMappingService languageMappingService,
			ISettingsService settingsService,
			IClientService clientService)
		{
			_languageMappingService = languageMappingService;
			_settingsService = settingsService;
			_clientservice = clientService;
		}

		// ---------------------- PAGE LOAD ----------------------
		[HttpGet]
		public async Task<IActionResult> AddLanguage()
		{
			var project = await _settingsService.GetSettingsAsync<GeneralSettingsModel>();
			var client = await _clientservice.GetClientById(project.ClientId);

			ProjectId = project.Id;
			ClientUuid = client.ClientUuid;
			UserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));

			await LoadData();

			return View(new ServiceLanguageMappingModel { AddEdit = "Add", IsActive = true });
		}

		// ---------------------- SAVE & UPDATE ----------------------
		[HttpPost]
		public async Task<IActionResult> AddLanguage([FromForm] ServiceLanguageMappingModel model)
		{
			await LoadData();

			// ----- UPDATE -----
			if (model.AddEdit == "Edit")
			{
				await _languageMappingService.UpdateMRFLanguage(ProjectId, model.LanguageId, model.IsActive);

				ViewBag.Smessage = "Language updated successfully.";

				return View(model);
			}

			// ----- CREATE -----
			if (model.LanguageId <= 0)
			{
				ViewBag.Smessage = "Please select a language.";
				return View(model);
			}

			var existing = await _languageMappingService.GetList(ProjectId);

			if (existing.Any(x => x.LanguageId == model.LanguageId))
			{
				ViewBag.Smessage = "This language already exists for this MRF.";
				return View(model);
			}

			// Create new MRFLanguage entry
			var dto = new MRFLanguage
			{
				ProjectId = ProjectId,
				LanguageId = model.LanguageId,
				IsActive = model.IsActive
			};

			await _languageMappingService.CreateMRFLanguage(new List<MRFLanguage> { dto });
			await _languageMappingService.CreateMRFLanguageResource(new List<MRFLanguage> { dto });

			ViewBag.Smessage = "Language added successfully.";

			await LoadData();
			return View(new ServiceLanguageMappingModel { AddEdit = "Add", IsActive = true });
		}

		// ---------------------- LOAD GRID DATA ----------------------
		public async Task LoadData()
		{
			ViewBag.ProjectId = ProjectId;
			ViewBag.LanguageList = await _languageMappingService.LoadRequestLanguages();
			ViewBag.ServiceLanguageMappingList = await _languageMappingService.GetList(ProjectId);
		}

		// ---------------------- DELETE ----------------------
		public async Task<IActionResult> Delete(int langid)
		{
			await _languageMappingService.DeleteMRFLanguage(ProjectId, langid);
			await _languageMappingService.DeleteMRFLanguageResource(ProjectId, langid);

			return RedirectToAction("AddLanguage");
		}

		// ---------------------- EDIT AJAX ----------------------
		public async Task<IActionResult> Edit(int projectId, int langid)
		{
			var item = await _languageMappingService.GetItem(projectId, langid);

			if (item == null)
				return NotFound();

			return Json(new
			{
				languageId = item.LanguageId,
				isActive = item.IsActive
			});
		}
	}
}


@using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping
@model GoRegister.ApplicationCore.Domain.ServiceLanguageMapping.ServiceLanguageMappingModel

<div class="card">
    <div class="card-header">
        <h3>MRF Language Mapping</h3>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-5">

                @using (Html.BeginForm("AddLanguage", "LanguageMapping", FormMethod.Post))
                {
                    <input type="hidden" asp-for="LanguageId" id="LanguageIdHidden" />
                    <input type="hidden" asp-for="AddEdit" id="AddEdit" />

                    @if (!string.IsNullOrWhiteSpace(ViewBag.Smessage))
                    {
                        <div class="alert alert-info">@ViewBag.Smessage</div>
                    }

                    <div class="form-group mb-3">
                        <label>Select Language</label>

                        <select id="ddlLanguages" class="auto-complete-select form-control">
                            <option value="">~ choose ~</option>
                            @foreach (var cty in ViewBag.LanguageList)
                            {
                                <option value="@cty.Value">@cty.Text</option>
                            }
                        </select>
                        <span class="text-danger" id="LangValidation"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label>IsActive</label>
                        <select asp-for="IsActive" class="form-control" id="IsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>

                    <div>
                        <button class="btn btn-success" id="saveBtn">
                            @(Model.AddEdit == "Edit" ? "Update" : "Save")
                        </button>

                        <a class="btn btn-secondary" id="clearBtn">Clear</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<hr />

<div class="card">
    <div class="card-header">
        <h3>Mapped Language(s)</h3>
    </div>

    <div class="card-body">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Language</th>
                    <th>IsActive</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <tbody>
                @if (ViewBag.ServiceLanguageMappingList == null || !((List<ServiceLanguageMappingModel>)ViewBag.ServiceLanguageMappingList).Any())
                {
                    <tr>
                        <td colspan="4" class="text-center">No language mapped</td>
                    </tr>
                }
                else
                {
                    foreach (var item in (List<ServiceLanguageMappingModel>)ViewBag.ServiceLanguageMappingList)
                    {
                        <tr>
                            <td>@item.RequestLanguage</td>
                            <td>@(item.IsActive ? "Active" : "Inactive")</td>
                            <td>
                                <button class="btn btn-primary btn-sm"
                                        onclick="editItem(@item.LanguageId)">Edit</button>
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteItem(@item.LanguageId)">Delete</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#ddlLanguages').select2({
                placeholder: '~ choose ~',
                allowClear: true,
                width: '100%'
            });
        });

        $("#saveBtn").click(function () {
            let langId = $("#ddlLanguages").val();

            if (!langId) {
                $("#LangValidation").text("Please select a language.");
                return false;
            }

            $("#LanguageIdHidden").val(langId);
            return true;
        });

        function editItem(langId) {
            $.ajax({
                url: `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Edit`,
                data: { langid: langId },
                type: 'GET',
                success: function (data) {
                    $("#LanguageIdHidden").val(data.languageId);
                    $("#ddlLanguages").val(data.languageId).trigger('change');
                    $("#IsActive").val(data.isActive.toString());
                    $("#AddEdit").val("Edit");
                    $("#saveBtn").text("Update");
                },
                error: function () {
                    alert("Error loading selected item.");
                }
            });
        }

        function deleteItem(langId) {
            if (!confirm("Are you sure?")) return;

            window.location.href =
                `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Delete?langid=${langId}`;
        }

        $("#clearBtn").click(function () {
            $("#ddlLanguages").val("").trigger('change');
            $("#LanguageIdHidden").val("");
            $("#IsActive").val("true");
            $("#AddEdit").val("Add");
            $("#saveBtn").text("Save");
            $("#LangValidation").text("");
        });
    </script>
}


***********************************************************************************************************************

using FluentValidation.Resources;
using GoRegister.ApplicationCore.Data.Models;
using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.Countries;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.ServiceCountryMapping;
using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.ApplicationCore.Framework;
using GoRegister.Areas.Admin.Controllers;
using Humanizer;
using Microsoft.AspNetCore.Mvc;
using Microsoft.CodeAnalysis;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.LanguageMapping
{
	public class LanguageMappingController : ProjectAdminControllerBase
	{

		private readonly IServiceLanguageMappingService _languageMappingService;
		private readonly IProjectService _projectService;
		private readonly ISettingsService _settingsService;
		private readonly IClientService _clientservice;
		public static int ProjectId { get; set; }
		public static string ClientUuid { get; set; }
		public static int UserId { get; set; }
		public static string AddEdit { get; set; }
		public LanguageMappingController(IServiceLanguageMappingService languageMappingService, IProjectService projectService, ISettingsService settingsService, IClientService clientService)
		{
			_languageMappingService = languageMappingService;
			_projectService = projectService;
			_settingsService = settingsService;
			_clientservice = clientService;
		}

		[HttpGet]
		public async Task<IActionResult> AddLanguage()
		{
			var project = await _settingsService.GetSettingsAsync<GeneralSettingsModel>();
			var client = await _clientservice.GetClientById(project.ClientId);
			ProjectId = project.Id;
			ClientUuid = client.ClientUuid;
			UserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
			await LoadData();
			AddEdit = "Add";
			return View();
		}

		[HttpPost]
		public async Task<IActionResult> AddLanguage([FromForm] ServiceLanguageMappingModel model)
		{
			await LoadData();
			if (model.AddEdit == "Edit")
			{
				await _languageMappingService.UpdateMRFLanguage(ProjectId, model.LanguageId, model.IsActive);
				ViewBag.Smessage = "Language updated successfully.";
				return View(model);
			}

			if (!ModelState.IsValid || model.LanguageId <= 0)
			{				
				ViewBag.Smessage = "Please select a language.";
				return View(model);
			}

			//var languageIds = model.RequestLanguage
			//	.Split(",", StringSplitOptions.RemoveEmptyEntries)
			//	.Select(ct => new MRFLanguage
			//	{
			//		ProjectId = ProjectId,
			//		LanguageId = int.Parse(ct)
			//	})
			//	.ToList();

			var languages = await _languageMappingService.GetLanguages();
			var eng = languages.Where(l => l.LanguageCode.ToLower() == "en");

			var existingLanguages = await _languageMappingService.GetList(ProjectId);
			var existingLanguageIds = existingLanguages.Select(lang => lang.LanguageId).ToHashSet();

			List<MRFLanguage> dtos = new List<MRFLanguage>();
			int existLang = 0;
			int newLang = 0;
			var rqct = model.RequestLanguage.Split(",", StringSplitOptions.RemoveEmptyEntries);
			foreach (string ct in rqct)
			{
				int languageId = int.Parse(ct);
				if (!existingLanguageIds.Contains(languageId))
				{
					MRFLanguage dto = new MRFLanguage
					{
						ProjectId = ProjectId,
						LanguageId = languageId
					};
					dtos.Add(dto);
					newLang += 1;
				}
				else
				{
					existLang += 1;
				}
			}

			if (!dtos.Any())
			{
				ViewBag.Smessage = "Selected languages are already added to the MRF";
				await LoadData();
				return View(model);
			}

			if (existLang > 0 && newLang > 0)
			{
				await _languageMappingService.CreateMRFLanguage(dtos);
				await _languageMappingService.CreateMRFLanguageResource(dtos);
				ViewBag.Smessage = "Some of selected languages are already exist and the other added successfully to the MRF.";
				await LoadData();
				return View(model);
			}

			await _languageMappingService.CreateMRFLanguage(dtos);
			await _languageMappingService.CreateMRFLanguageResource(dtos);
			ViewBag.Smessage = "Selected language(s) are successfully added to the MRF.";
			await LoadData();
			return View(model);
		}

		public async Task LoadData()
		{
			ViewBag.ProjectId = ProjectId;
			ViewBag.LanguageList = await _languageMappingService.LoadRequestLanguages();
			ViewBag.ServiceLanguageMappingList = await _languageMappingService.GetList(ProjectId);
		}

		public async Task<IActionResult> Delete(int langid)
		{
			await _languageMappingService.DeleteMRFLanguage(ProjectId, langid);
			await _languageMappingService.DeleteMRFLanguageResource(ProjectId, langid);
			ViewBag.Smessage = "Language successfully deleted.";
			await LoadData();
			return RedirectToAction("AddLanguage", "LanguageMapping", new { refresh = true });
		}

		public async Task<IActionResult> Edit(int projectId, int langid)
		{
			var item = await _languageMappingService.GetItem(projectId, langid);

			if (item == null)
				return NotFound();

			return Json(new
			{
				languageId = item.LanguageId,
				isActive = item.IsActive
			});
		}

	}
}



@using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping
@model GoRegister.ApplicationCore.Domain.ServiceLanguageMapping.ServiceLanguageMappingModel

<div class="card">
    <div class="card-header">
        <h3>MRF Language Mapping</h3>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-5">

                @using (Html.BeginForm("AddLanguage", "LanguageMapping", FormMethod.Post))
                {
                    @* Hidden fields for binding *@
                    <input type="hidden" asp-for="LanguageId" id="LanguageIdHidden" />
                    <input type="hidden" asp-for="AddEdit" id="AddEdit" />

                    @if (!string.IsNullOrWhiteSpace(ViewBag.Smessage))
                    {
                        <div class="alert alert-info">@ViewBag.Smessage</div>
                    }

                    <div class="form-group mb-3">
                        <label>Select Language</label>

                        @* Do NOT bind using asp-for to avoid disabled select blocking model binding *@
                        <select id="ddlLanguages" class="auto-complete-select form-control">
                            <option value="">~ choose ~</option>
                            @if (ViewBag.LanguageList != null)
                            {
                                foreach (var cty in ViewBag.LanguageList)
                                {
                                    <option value="@cty.Value">@cty.Text</option>
                                }
                            }
                        </select>
                        <span class="text-danger" id="LangValidation"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label>IsActive</label>
                        <select asp-for="IsActive" class="form-control" id="IsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>

                    <div>
                        <button class="btn btn-success" id="saveBtn">
                            @(Model.AddEdit == "Edit" ? "Update" : "Save")
                        </button>

                        <a class="btn btn-secondary" id="clearBtn">Clear</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>


<hr />

<div class="card">
    <div class="card-header">
        <h3>Mapped Language(s)</h3>
    </div>

    <div class="card-body">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Language</th>
                    <th>IsActive</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>

            <tbody>
                @{
                    var list = ViewBag.ServiceLanguageMappingList as List<ServiceLanguageMappingModel>;
                }

                @if (list == null || !list.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center">No language mapped</td>
                    </tr>
                }
                else
                {
                    foreach (var item in list)
                    {
                        <tr>
                            <td>@item.RequestLanguage</td>
                            <td>@(item.IsActive ? "Active" : "Inactive")</td>
                            <td>
                                <button class="btn btn-primary btn-sm"
                                        onclick="editItem(@item.LanguageId)">Edit</button>
                            </td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                        onclick="deleteItem(@item.LanguageId)">Delete</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Select2
            $('#ddlLanguages').select2({
                placeholder: '~ choose ~',
                allowClear: true,
                width: '100%'
            });
        });

        // SAVE / UPDATE BUTTON
        $("#saveBtn").click(function () {
            let langId = $("#ddlLanguages").val();

            if (!langId) {
                $("#LangValidation").text("Please select a language.");
                return false;
            }

            $("#LangValidation").text("");

            // Set hidden binding value
            $("#LanguageIdHidden").val(langId);
            return true;
        });


        // EDIT FUNCTION
        function editItem(langId) {
            $.ajax({
                url: `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Edit`,
                data: { langid: langId },
                type: 'GET',
                success: function (data) {

                    $("#LanguageIdHidden").val(data.languageId);
                    $("#ddlLanguages").val(data.languageId).trigger('change');

                    $("#IsActive").val(data.isActive.toString());
                    $("#AddEdit").val("Edit");

                    $("#saveBtn").text("Update");
                },
                error: function () {
                    alert("Error loading selected item.");
                }
            });
        }


        // DELETE FUNCTION
        function deleteItem(langId) {
            if (!confirm("Are you sure you want to delete this language?"))
                return;

            window.location.href =
                `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Delete?langid=${langId}`;
        }


        // CLEAR FORM
        $("#clearBtn").click(function () {

            $("#ddlLanguages").val("").trigger('change');
            $("#LanguageIdHidden").val("");

            $("#IsActive").val("true");
            $("#AddEdit").val("Add");
            $("#saveBtn").text("Save");

            $("#LangValidation").text("");
        });
    </script>
}




@using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping
@model GoRegister.ApplicationCore.Domain.ServiceLanguageMapping.ServiceLanguageMappingModel
<div class="card">
	<div class="card-header">
		<h3>
			MRF Language Mapping
		</h3>
	</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-4">
				@using (Html.BeginForm())
				{
					<div class="form-group">
						<label asp-for="RequestLanguage">Select Languages(s)</label>
						<select asp-for="LanguageId" class="auto-complete-select form-control">
							@if (ViewBag.LanguageList != null)
							{
								foreach (var cty in ViewBag.LanguageList)
								{
									<option value="@cty.Value">@cty.Text</option>
								}
							}
						</select>
						<label id="smsg" class="text-danger">@ViewBag.Smessage</label>
						<input type="hidden" id="rql" asp-for="RequestLanguage" />
						<input type="hidden" id="rqlid" asp-for="LanguageId" />
						<input type="hidden" id="addedit" asp-for="AddEdit" />						
					</div>
					<div class="form-group">
						<label>IsActive</label>
						<select asp-for="IsActive" class="form-control" id="IsActive">
							<option value="true">Active</option>
							<option value="false">InActive</option>
						</select>
					</div>
					<div>
						<input class="btn btn-success mt-2" type="submit" value="Save" id="save" />
						<a class="btn btn-success mt-2" id="cancel" onclick="cancel()">Cancel</a>
					</div>
				}
			</div>
		</div>
	</div>
</div>

<div class="card">
	<div class="card-header">
		<h3>
			Mapped Language(s)
		</h3>
	</div>
	<div class="card-body">
		<table class="table table-hover table-bordered">
			<thead class="table-dark">
				<tr>
					<td style="width:30%">Language(s)</td>
					<td style="width:30%">IsActive</td>
					<td style="width:20%">Edit</td>
					<td style="width:20%">Delete</td>
				</tr>
			</thead>
			<tbody>
				@{
					var mappingList = ViewBag.ServiceLanguageMappingList as List<ServiceLanguageMappingModel>;
				}
				@if (mappingList == null || !mappingList.Any())
				{
					<tr>
						<td colspan="2" class="text-center">No language mapped</td>
					</tr>
				}
				else
				{
					foreach (var dt in mappingList)
					{
						<tr>
							<td style="width:30%">
								@dt.RequestLanguage
							</td> 
							<td style="width:30%">
								@(dt.IsActive ? "Active" : "InActive")
							</td>
							<td style="width:20%">
								<button id="editmap" onclick="edit('@dt.LanguageId',this)" class="btn btn-primary btn-sm">Edit</button>
							</td>
							<td style="width:20%">
								<button id="deletemap" onclick="deletemap('@dt.LanguageId',this)" class="btn btn-danger btn-sm">Delete</button>
							</td>
						</tr>
					}
				}
			</tbody>
		</table>
	</div>
</div>

@section Scripts {
	<script>

		$(document).ready(function () {
			$('.auto-complete-select').select2({
				multiple: true,
				placeholder: '~ choose ~',
				allowClear: true
			});
		});
		$(function () {
			$("#save").click(function () {
				var dt = $('.auto-complete-select').val();
				var isActive = $("#IsActive").val();
				if (dt == '') {
					$('#smsg').text('Please select a language.');
					return;
				} else {
					$('#smsg').text('');
				}
				$("#rql").val(dt);
				$("#rqlid").val(isActive);
			});
		});

		function edit(langId, e) {
			var url = `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Edit`;
			$.ajax({
				url: url,
				data: { langid: langId },
				type: 'GET',
				success: function (data) {
					$("#rqctid").val(data.languageId);
					$("#IsActive").val(data.isActive.toString());
					$(".auto-complete-select").val([data.languageId]).trigger('change');
					$('.auto-complete-select').prop('disabled', true);
					$("#addedit").val("Edit");
					$("#save").val("Update");
				},
				error: function () {
					alert("Failed to load editing item.");
				}
			});
		}
		function cancel() {
			$(".auto-complete-select").prop('disabled', false);
			$(".auto-complete-select").val(null).trigger('change');
			$("#IsActive").val("true");
			$("#addedit").val("Add");
			$("#save").val("Save");
			$("#rqctid").val("");
		}
		// function cancel() {
		// 	$(".auto-complete-select").val(null).trigger('change');
		// 	$('#smsg').text('');
		// }
		function deletemap(id, e) {
			var url = '/admin/project/' + @ViewBag.ProjectId + '/LanguageMapping/Delete'
			$.ajax({
				url: url,
				data: { langid: id },
				type: 'GET',
				datatype: 'json',
				success: function (r) {
					$(e).closest('tr').remove();
					$("#lblcount").text(r);
				},
				error: function (e) {
					alert(e);
				},
			});
		}
	</script>
}



using FluentValidation.Resources;
using GoRegister.ApplicationCore.Data.Models;
using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.Countries;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.ServiceCountryMapping;
using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.ApplicationCore.Framework;
using GoRegister.Areas.Admin.Controllers;
using Humanizer;
using Microsoft.AspNetCore.Mvc;
using Microsoft.CodeAnalysis;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.LanguageMapping
{
	public class LanguageMappingController : ProjectAdminControllerBase
	{

		private readonly IServiceLanguageMappingService _languageMappingService;
		private readonly IProjectService _projectService;
		private readonly ISettingsService _settingsService;
		private readonly IClientService _clientservice;
		public static int ProjectId { get; set; }
		public static string ClientUuid { get; set; }
		public static int UserId { get; set; }
		public static string AddEdit { get; set; }
		public LanguageMappingController(IServiceLanguageMappingService languageMappingService, IProjectService projectService, ISettingsService settingsService, IClientService clientService)
		{
			_languageMappingService = languageMappingService;
			_projectService = projectService;
			_settingsService = settingsService;
			_clientservice = clientService;
		}

		[HttpGet]
		public async Task<IActionResult> AddLanguage()
		{
			var project = await _settingsService.GetSettingsAsync<GeneralSettingsModel>();
			var client = await _clientservice.GetClientById(project.ClientId);
			ProjectId = project.Id;
			ClientUuid = client.ClientUuid;
			UserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
			await LoadData();
			AddEdit = "Add";
			return View();
		}

		[HttpPost]
		public async Task<IActionResult> AddLanguage([FromForm] ServiceLanguageMappingModel model)
		{
			await LoadData();
			if (model.AddEdit == "Edit")
			{
				await _languageMappingService.UpdateMRFLanguage(ProjectId, model.LanguageId, model.IsActive);
				ViewBag.Smessage = "Language updated successfully.";
				return View(model);
			}

			if (!ModelState.IsValid || model.LanguageId <= 0)
			{				
				ViewBag.Smessage = "Please select a language.";
				return View(model);
			}

			//var languageIds = model.RequestLanguage
			//	.Split(",", StringSplitOptions.RemoveEmptyEntries)
			//	.Select(ct => new MRFLanguage
			//	{
			//		ProjectId = ProjectId,
			//		LanguageId = int.Parse(ct)
			//	})
			//	.ToList();

			var languages = await _languageMappingService.GetLanguages();
			var eng = languages.Where(l => l.LanguageCode.ToLower() == "en");

			var existingLanguages = await _languageMappingService.GetList(ProjectId);
			var existingLanguageIds = existingLanguages.Select(lang => lang.LanguageId).ToHashSet();

			List<MRFLanguage> dtos = new List<MRFLanguage>();
			int existLang = 0;
			int newLang = 0;
			var rqct = model.RequestLanguage.Split(",", StringSplitOptions.RemoveEmptyEntries);
			foreach (string ct in rqct)
			{
				int languageId = int.Parse(ct);
				if (!existingLanguageIds.Contains(languageId))
				{
					MRFLanguage dto = new MRFLanguage
					{
						ProjectId = ProjectId,
						LanguageId = languageId
					};
					dtos.Add(dto);
					newLang += 1;
				}
				else
				{
					existLang += 1;
				}
			}

			if (!dtos.Any())
			{
				ViewBag.Smessage = "Selected languages are already added to the MRF";
				await LoadData();
				return View(model);
			}

			if (existLang > 0 && newLang > 0)
			{
				await _languageMappingService.CreateMRFLanguage(dtos);
				await _languageMappingService.CreateMRFLanguageResource(dtos);
				ViewBag.Smessage = "Some of selected languages are already exist and the other added successfully to the MRF.";
				await LoadData();
				return View(model);
			}

			await _languageMappingService.CreateMRFLanguage(dtos);
			await _languageMappingService.CreateMRFLanguageResource(dtos);
			ViewBag.Smessage = "Selected language(s) are successfully added to the MRF.";
			await LoadData();
			return View(model);
		}

		public async Task LoadData()
		{
			ViewBag.ProjectId = ProjectId;
			ViewBag.LanguageList = await _languageMappingService.LoadRequestLanguages();
			ViewBag.ServiceLanguageMappingList = await _languageMappingService.GetList(ProjectId);
		}

		public async Task<IActionResult> Delete(int langid)
		{
			await _languageMappingService.DeleteMRFLanguage(ProjectId, langid);
			await _languageMappingService.DeleteMRFLanguageResource(ProjectId, langid);
			ViewBag.Smessage = "Language successfully deleted.";
			await LoadData();
			return RedirectToAction("AddLanguage", "LanguageMapping", new { refresh = true });
		}

		public async Task<IActionResult> Edit(int projectId, int langid)
		{
			var item = await _languageMappingService.GetItem(projectId, langid);

			if (item == null)
				return NotFound();

			return Json(new
			{
				languageId = item.LanguageId,
				isActive = item.IsActive
			});
		}

	}
}

=========================

[HttpGet("Edit")]
public async Task<IActionResult> Edit(int projectId, int langid)
{
    var item = await _languageMappingService.GetItem(projectId, langid);

    if (item == null)
        return NotFound();

    return Json(new {
        languageId = item.LanguageId,
        isActive = item.IsActive
    });
}

Task<MRFLanguage> GetItem(int projectId, int langId);
public async Task<MRFLanguage> GetItem(int projectId, int langId)
{
    return await _db.MRFLanguage
        .FirstOrDefaultAsync(x => x.ProjectId == projectId && x.LanguageId == langId);
}
Task UpdateMRFLanguage(int projectId, int langId, bool isActive);
public async Task UpdateMRFLanguage(int projectId, int langId, bool isActive)
{
    var entity = await _db.MRFLanguage
        .FirstOrDefaultAsync(x => x.ProjectId == projectId && x.LanguageId == langId);

    if (entity != null)
    {
        entity.IsActive = isActive;
        await _db.SaveChangesAsync();
    }
}



<input type="hidden" id="addedit" asp-for="AddEdit" />
<input type="hidden" id="rqctid" asp-for="LanguageId" />

function edit(langId) {

    var url = `/admin/project/${@ViewBag.ProjectId}/LanguageMapping/Edit`;

    $.ajax({
        url: url,
        data: { langid: langId },
        type: 'GET',
        success: function (data) {

            // Set hidden language ID
            $("#rqctid").val(data.languageId);

            // Populate IsActive
            $("#IsActive").val(data.isActive.toString());

            // Disable language select2
            $(".auto-complete-select").val([data.languageId]).trigger('change');
            $('.auto-complete-select').prop('disabled', true);

            // Show edit mode
            $("#addedit").val("Edit");
            $("#save").val("Update");
        },
        error: function () {
            alert("Failed to load editing item.");
        }
    });
}
function cancel() {
    $(".auto-complete-select").prop('disabled', false);
    $(".auto-complete-select").val(null).trigger('change');
    $("#IsActive").val("true");
    $("#addedit").val("Add");
    $("#save").val("Save");
    $("#rqctid").val("");
}


[HttpPost]
public async Task<IActionResult> AddLanguage([FromForm] ServiceLanguageMappingModel model)
{
    await LoadData();

    if (model.AddEdit == "Edit")
    {
        // Update language IsActive only
        await _languageMappingService.UpdateMRFLanguage(ProjectId, model.LanguageId, model.IsActive);
        ViewBag.Smessage = "Language updated successfully.";
        return View(model);
    }

    // ---------- ADD LOGIC (existing) ----------
    if (!ModelState.IsValid || model.LanguageId <= 0)
    {
        ViewBag.Smessage = "Please select a language.";
        return View(model);
    }

    var existing = await _languageMappingService.GetList(ProjectId);
    var existingIds = existing.Select(x => x.LanguageId).ToHashSet();

    var langIds = model.RequestLanguage.Split(",", StringSplitOptions.RemoveEmptyEntries);

    List<MRFLanguage> newItems = new();

    foreach (var lang in langIds)
    {
        int id = int.Parse(lang);
        if (!existingIds.Contains(id))
        {
            newItems.Add(new MRFLanguage { ProjectId = ProjectId, LanguageId = id, IsActive = true });
        }
    }

    if (!newItems.Any())
    {
        ViewBag.Smessage = "Language already exists.";
        return View(model);
    }

    await _languageMappingService.CreateMRFLanguage(newItems);
    ViewBag.Smessage = "Language added successfully.";

    return View(model);
}



==================================================================================================================================

@using GoRegister.ApplicationCore.Domain.CustomFieldResource
@model GoRegister.ApplicationCore.Domain.CustomFieldResource.CustomFieldResourceViewModel
<h2>Custom Field Resource</h2>



<form asp-action="AddCustomFieldMapping" asp-route-projectId="@Model.ProjectId" method="post">

	<input type="hidden" asp-for="ProjectId" />
	<input type="hidden" asp-for="MRFLanguageResourceId" />

	@if (Model.IsEditMode)
	{
		<input type="hidden" name="SelectedLanguageId" value="@Model.SelectedLanguageId" />
		<input type="hidden" name="SelectedFieldId" value="@Model.SelectedFieldId" />
	}

	<div class="row">
		<div class="col-md-4">
			<label>Language Selection</label>
			<select asp-for="SelectedLanguageId" asp-items="Model.Languages" class="form-control" disabled="@(Model.IsEditMode ? "disabled" : null)">
				<option value="">-- choose --</option>
			</select>
		</div>

		<div class="col-md-4">
			<label>Custom Field</label>
			<select asp-for="SelectedFieldId" asp-items="Model.CustomFields" class="form-control" disabled="@(Model.IsEditMode ? "disabled" : null)">
				<option value="">-- choose --</option>
			</select>
		</div>
	</div>
	<div class="row">
		<div class="col-md-4">
			<label>IsActive</label>
			<select asp-for="IsActive" class="form-control" id="IsActive">
				<option value="true">Active</option>
				<option value="false">InActive</option>
			</select>
		</div>
		<div class="col-md-4">
			<label>Language Resource</label>
			<input asp-for="LanguageResourceText" class="form-control" />
		</div>
	</div>

	<button class="btn btn-success mt-3" id="save">
		@(Model.IsEditMode ? "Update" : "Save")
	</button>

	<button type="button" class="btn btn-secondary mt-3" id="clearForm">
		Clear
	</button>

</form>

<br />

<!-- ERROR MESSAGE (Inline Validation: duplicate, missing fields) -->
@if (!string.IsNullOrEmpty(Model.ValidationMessage))
{
	<div class="alert alert-danger">
		@Model.ValidationMessage
	</div>
}

<!-- SUCCESS MESSAGE (Redirect-based) -->
@if (TempData["SuccessMessage"] != null)
{
	<div class="alert alert-success">
		@TempData["SuccessMessage"]
	</div>
}

<hr />

<h3>Language Resource Details</h3>

<table class="table table-hover table-bordered">
	<thead class="table-dark">
		<tr>
			<th>Language</th>
			<th>Custom Field</th>
			<th>Resource</th>
			<th>IsActive</th>
			<th>Edit</th>
			<th>Delete</th>
		</tr>
	</thead>

	<tbody>
		@foreach (var item in Model.ExistingResources)
		{
			<tr>
				<td>@item.LanguageName</td>
				<td>@item.FieldName</td>
				<td>@item.ResourceText</td>
				<td>@(item.IsActive ? "Active" : "Inactive")</td>
				<td>
					<form asp-action="Edit" asp-route-id="@item.Id" asp-route-projectId="@Model.ProjectId" method="get">
						<button class="btn btn-primary btn-sm">Edit</button>
					</form>
				</td>
				<td>
					<form asp-action="Delete" asp-route-id="@item.Id" asp-route-projectId="@Model.ProjectId" method="post">
						<button class="btn btn-danger btn-sm">Delete</button>
					</form>
				</td>
			</tr>
		}
	</tbody>
</table>

@section Scripts {
	<script>

		$(function () {

			$("#save").click(function () {
				var dt = $('#SelectedLanguageId').val();
				var field = $('#SelectedFieldId').val();
				if (dt == '') {
					$('#smsg').text('Please select a language.');
					return;
				} else {
					$('#smsg').text('');
				}
			});

			$("#clearForm").click(function () {
				// var isEditMode = @Model.IsEditMode.ToString().ToLower();
				// if (!isEditMode) {
				// 	document.getElementById("SelectedLanguageId").value = "";
				// 	document.getElementById("SelectedFieldId").value = "";
				//  document.getElementById("IsActive").value = "true";
				// }
				$("#LanguageResourceText").val('');
			});
	</script>
}

--------------------------------------------------------------------------------
using FluentValidation.Resources;
using GoRegister.ApplicationCore.Data.Models;
using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.Countries;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.ServiceCountryMapping;
using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.ApplicationCore.Framework;
using GoRegister.Areas.Admin.Controllers;
using Humanizer;
using Microsoft.AspNetCore.Mvc;
using Microsoft.CodeAnalysis;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.LanguageMapping
{
	public class LanguageMappingController : ProjectAdminControllerBase
	{

		private readonly IServiceLanguageMappingService _languageMappingService;
		private readonly IProjectService _projectService;
		private readonly ISettingsService _settingsService;
		private readonly IClientService _clientservice;
		public static int ProjectId { get; set; }
		public static string ClientUuid { get; set; }
		public static int UserId { get; set; }
		public static string AddEdit { get; set; }
		public LanguageMappingController(IServiceLanguageMappingService languageMappingService, IProjectService projectService, ISettingsService settingsService, IClientService clientService)
		{
			_languageMappingService = languageMappingService;
			_projectService = projectService;
			_settingsService = settingsService;
			_clientservice = clientService;
		}

		[HttpGet]
		public async Task<IActionResult> AddLanguage()
		{
			var project = await _settingsService.GetSettingsAsync<GeneralSettingsModel>();
			var client = await _clientservice.GetClientById(project.ClientId);
			ProjectId = project.Id;
			ClientUuid = client.ClientUuid;
			UserId = int.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
			await LoadData();
			AddEdit = "Add";
			return View();
		}

		[HttpPost]
		public async Task<IActionResult> AddLanguage([FromForm] ServiceLanguageMappingModel model)
		{
			if (!ModelState.IsValid || model.LanguageId <= 0)
			{
				await LoadData();
				ViewBag.Smessage = "Please select a language.";
				return View(model);
			}

			//var languageIds = model.RequestLanguage
			//	.Split(",", StringSplitOptions.RemoveEmptyEntries)
			//	.Select(ct => new MRFLanguage
			//	{
			//		ProjectId = ProjectId,
			//		LanguageId = int.Parse(ct)
			//	})
			//	.ToList();

			var languages = await _languageMappingService.GetLanguages();
			var eng = languages.Where(l => l.LanguageCode.ToLower() == "en");
			var existingLanguages = await _languageMappingService.GetList(ProjectId);
			var existingLanguageIds = existingLanguages.Select(lang => lang.LanguageId).ToHashSet();

			List<MRFLanguage> dtos = new List<MRFLanguage>();
			int existLang = 0;
			int newLang = 0;
			var rqct = model.RequestLanguage.Split(",", StringSplitOptions.RemoveEmptyEntries);
			foreach (string ct in rqct)
			{
				int languageId = int.Parse(ct);
				if (!existingLanguageIds.Contains(languageId))
				{
					MRFLanguage dto = new MRFLanguage
					{
						ProjectId = ProjectId,
						LanguageId = languageId
					};
					dtos.Add(dto);
					newLang += 1;
				}
				else
				{
					existLang += 1;
				}
			}

			if (!dtos.Any())
			{
				ViewBag.Smessage = "Selected languages are already added to the MRF";
				await LoadData();
				return View(model);
			}

			if (existLang > 0 && newLang > 0)
			{
				await _languageMappingService.CreateMRFLanguage(dtos);
				await _languageMappingService.CreateMRFLanguageResource(dtos);
				ViewBag.Smessage = "Some of selected languages are already exist and the other added successfully to the MRF.";
				await LoadData();
				return View(model);
			}

			await _languageMappingService.CreateMRFLanguage(dtos);
			await _languageMappingService.CreateMRFLanguageResource(dtos);
			ViewBag.Smessage = "Selected language(s) are successfully added to the MRF.";
			await LoadData();
			return View(model);
		}

		public async Task LoadData()
		{
			ViewBag.ProjectId = ProjectId;
			ViewBag.LanguageList = await _languageMappingService.LoadRequestLanguages();
			ViewBag.ServiceLanguageMappingList = await _languageMappingService.GetList(ProjectId);
		}

		public async Task<IActionResult> Delete(int langid)
		{
			await _languageMappingService.DeleteMRFLanguage(ProjectId, langid);
			await _languageMappingService.DeleteMRFLanguageResource(ProjectId, langid);
			ViewBag.Smessage = "Language successfully deleted.";
			await LoadData();
			return RedirectToAction("AddLanguage", "LanguageMapping", new { refresh = true });
		}

	}
}



@using GoRegister.ApplicationCore.Domain.ServiceLanguageMapping
@model GoRegister.ApplicationCore.Domain.ServiceLanguageMapping.ServiceLanguageMappingModel
<div class="card">
	<div class="card-header">
		<h3>
			MRF Language Mapping
		</h3>
	</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-4">
				@using (Html.BeginForm())
				{
					<div class="form-group">
						<label asp-for="RequestLanguage">Select Languages(s)</label>
						<select asp-for="LanguageId" class="auto-complete-select form-control">
							@if (ViewBag.LanguageList != null)
							{
								foreach (var cty in ViewBag.LanguageList)
								{
									<option value="@cty.Value">@cty.Text</option>
								}
							}
						</select>
						<label id="smsg" class="text-danger">@ViewBag.Smessage</label>
						<input type="hidden" id="rqct" asp-for="RequestLanguage" />
						<input type="hidden" id="rqctid" asp-for="LanguageId" />
						<input type="hidden" id="addedit" asp-for="AddEdit" />
					</div>
					<div class="form-group">
						<label>IsActive</label>
						<select asp-for="IsActive" class="form-control" id="IsActive">
							<option value="true">Active</option>
							<option value="false">Inactive</option>
						</select>
					</div>
					<div>
						<input class="btn btn-success mt-2" type="submit" value="Save" id="save" />
						<a class="btn btn-success mt-2" id="cancel" onclick="cancel()">Cancel</a>
					</div>
				}
			</div>
		</div>
	</div>
</div>

<div class="card">
	<div class="card-header">
		<h3>
			Mapped Language(s)
		</h3>
	</div>
	<div class="card-body">
		<table class="table table-hover table-bordered">
			<thead class="table-dark">
				<tr>
					<td style="width:20%">Language(s)</td>
					<td style="width:20%">IsActive</td>
					<td style="width:10%">Delete</td>
				</tr>
			</thead>
			<tbody>
				@{
					var mappingList = ViewBag.ServiceLanguageMappingList as List<ServiceLanguageMappingModel>;
				}
				@if (mappingList == null || !mappingList.Any())
				{
					<tr>
						<td colspan="2" class="text-center">No language mapped</td>
					</tr>
				}
				else
				{
					foreach (var dt in mappingList)
					{
						<tr>
							<td style="width:20%">
								@dt.RequestLanguage
							</td>
							<td style="width:20%">
								@(dt.IsActive ? "Active" : "Inactive")
							</td>
							<td style="width:10%">
								<button id="deletemap" onclick="deletemap('@dt.LanguageId',this)" class="btn btn-primary">Delete</button>
							</td>
						</tr>
					}
				}
			</tbody>
		</table>
	</div>
</div>

@section Scripts {
	<script>

		$(document).ready(function () {

			$('.auto-complete-select').select2({
				multiple: true,
				placeholder: '~ choose ~',
				allowClear: true
			});

		});
		$(function () {
			$("#save").click(function () {
				var dt = $('.auto-complete-select').val();
				if (dt == '') {
					$('#smsg').text('Please select a language.');
					return;
				} else {
					$('#smsg').text('');
				}
				$("#rqct").val(dt);

			});
		});
		function edit(id) {
			var url = '/admin/project/' + @ViewBag.ProjectId + '/LanguageMapping/Edit'
			alert(url);
			$.ajax({
				url: url,
				data: { langid: id },
				type: 'GET',
				datatype: 'json',
				success: function (r) {
					$(".selectservcty").val(r.serviceCountryUuid);
					$('.selectservcty').prop('disabled', true);
					var selectedValues = new Array();
					selectedValues = r.requestCountry.split(',').map(function (item) {
						return item.trim();
					});
					$(".auto-complete-select").val(selectedValues).trigger('change');
					$("#cancel").attr("hidden", false);
					$("#addedit").val("Edit");
				},
				error: function (e) {
					alert(e);
				},
			});
		}
		function cancel() {
			$(".auto-complete-select").val(null).trigger('change');
			$('#smsg').text('');
		}
		function deletemap(id, e) {
			var url = '/admin/project/' + @ViewBag.ProjectId + '/LanguageMapping/Delete'
			$.ajax({
				url: url,
				data: { langid: id },
				type: 'GET',
				datatype: 'json',
				success: function (r) {
					$(e).closest('tr').remove();
					$("#lblcount").text(r);
				},
				error: function (e) {
					alert(e);
				},
			});
		}
	</script>
}

----------------------------------------------------------------------------------------------------------------------------------------



<button type="button" class="btn btn-secondary mt-3" id="clearForm">
    Clear
</button>

<select asp-for="IsActive" class="form-control" id="IsActive">


@section Scripts {
<script>
    document.getElementById("clearForm").addEventListener("click", function () {

        // Clear dropdowns ONLY if we are not in edit mode
        var isEditMode = @Model.IsEditMode.ToString().ToLower();

        if (!isEditMode) {
            document.getElementById("SelectedLanguageId").value = "";
            document.getElementById("SelectedFieldId").value = "";
        }

        // Clear language resource textbox
        document.getElementById("LanguageResourceText").value = "";

        // Clear IsActive dropdown (only when creating)
        if (!isEditMode) {
            document.getElementById("IsActive").value = "true";
        }
    });
</script>
}



@* Hidden fields required ONLY for Edit mode *@
    @if (Model.IsEditMode)
    {
        <input type="hidden" name="SelectedLanguageId" value="@Model.SelectedLanguageId" />
        <input type="hidden" name="SelectedFieldId" value="@Model.SelectedFieldId" />
    }

@if (Model.HasError)
{
    <div class="alert alert-danger">@Model.ValidationMessage</div>
}
@if (TempData["SuccessMessage"] is string msg)
{
    <div class="alert alert-success">@msg</div>
}


[HttpPost]
public async Task<IActionResult> AddCustomFieldMapping([FromForm] CustomFieldResourceViewModel vm)
{
    if (vm.SelectedLanguageId != 0 && vm.SelectedFieldId != 0 && !string.IsNullOrWhiteSpace(vm.LanguageResourceText))
    {
        if (vm.MRFLanguageResourceId.HasValue)
        {
            await _customFieldMappingService.UpdateAsync(vm);
            TempData["SuccessMessage"] = "Translation updated successfully!";
        }
        else
        {
            var exists = await _customFieldMappingService.ExistsAsync(vm.ProjectId, vm.SelectedLanguageId, vm.SelectedFieldId);
            if (exists)
            {
                var page = await _customFieldMappingService.ReloadPageWithSelectionsAsync(vm);
                page.ValidationMessage = "A resource already exists for this Language + Field.";
                return View(page);
            }

            await _customFieldMappingService.SaveAsync(vm);
            TempData["SuccessMessage"] = "Translation added successfully!";
        }
    }

    return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId = vm.ProjectId });
}



public async Task<bool> ExistsAsync(int projectId, int languageId, int fieldId)
{
    return await (
        from mr in _db.MRFLanguageResource
        join lr in _db.LanguageResource on mr.LanguageResourceId equals lr.Id
        where mr.ProjectId == projectId
              && mr.FieldId == fieldId
              && lr.LanguageId == languageId
              && lr.IsActive
        select mr.Id
    ).AnyAsync();
}
public async Task<(bool Success, string Error)> TrySaveAsync(CustomFieldResourceViewModel vm)
{
    bool exists = await ExistsAsync(vm.ProjectId, vm.SelectedLanguageId, vm.SelectedFieldId);

    if (exists)
        return (false, "A resource already exists for this Language and Custom Field.");

    await SaveAsync(vm); // your existing insert logic

    return (true, null);
}

*****************************

public async Task<CustomFieldResourceViewModel> ReloadPageWithSelectionsAsync(CustomFieldResourceViewModel vm)
{
    var page = await LoadPageAsync(vm.ProjectId);

    // Keep user's selected values
    page.MRFLanguageResourceId = vm.MRFLanguageResourceId;
    page.SelectedLanguageId    = vm.SelectedLanguageId;
    page.SelectedFieldId       = vm.SelectedFieldId;
    page.LanguageResourceText  = vm.LanguageResourceText;
    page.ValidationMessage     = vm.ValidationMessage;

    return page;
}




using GoRegister.ApplicationCore.Domain.CustomFieldResource;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.ApplicationCore.Domain.Clients;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.CustomFieldMapping
{
    [Area("Admin")]
    [Route("admin/project/{projectId:int}/customfieldmapping")]
    public class CustomFieldMappingController : Controller
    {
        private readonly ICustomFieldResourceCacheService _service;

        public CustomFieldMappingController(
            ICustomFieldResourceCacheService service)
        {
            _service = service;
        }

        // LOAD PAGE
        [HttpGet("")]
        public async Task<IActionResult> AddCustomFieldMapping(int projectId)
        {
            var vm = await _service.LoadPageAsync(projectId);
            return View(vm);
        }

        // SAVE (INSERT / UPDATE)
        [HttpPost("")]
        public async Task<IActionResult> AddCustomFieldMapping(
            [FromForm] CustomFieldResourceViewModel vm,
            int projectId)
        {
            // Required fields check
            if (vm.SelectedLanguageId == 0 ||
                vm.SelectedFieldId == 0 ||
                string.IsNullOrWhiteSpace(vm.LanguageResourceText))
            {
                vm.ValidationMessage = "All fields are required.";
                vm = await _service.ReloadPageWithSelectionsAsync(vm);
                return View(vm);
            }

            // INSERT MODE
            if (!vm.MRFLanguageResourceId.HasValue)
            {
                var exists = await _service.ExistsAsync(projectId,
                                                        vm.SelectedLanguageId,
                                                        vm.SelectedFieldId);

                if (exists)
                {
                    vm.ValidationMessage = "A resource already exists for this Language + Custom Field.";
                    vm = await _service.ReloadPageWithSelectionsAsync(vm);
                    return View(vm);
                }

                await _service.SaveAsync(vm);
                TempData["SuccessMessage"] = "Translation added successfully!";
            }
            else
            {
                // UPDATE MODE
                await _service.UpdateAsync(vm);
                TempData["SuccessMessage"] = "Translation updated successfully!";
            }

            return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId });
        }

        // EDIT
        [HttpGet("edit/{id:int}")]
        public async Task<IActionResult> Edit(int id, int projectId)
        {
            var vm = await _service.LoadPageAsync(projectId);
            var editItem = await _service.LoadForEditAsync(id, projectId);

            vm.MRFLanguageResourceId = editItem.MRFLanguageResourceId;
            vm.SelectedLanguageId = editItem.SelectedLanguageId;
            vm.SelectedFieldId = editItem.SelectedFieldId;
            vm.LanguageResourceText = editItem.LanguageResourceText;
            vm.DataTag = editItem.DataTag;
            vm.IsActive = editItem.IsActive;

            return View(nameof(AddCustomFieldMapping), vm);
        }

        // SOFT DELETE
        [HttpPost("delete/{id:int}")]
        public async Task<IActionResult> Delete(int id, int projectId)
        {
            await _service.DeleteAsync(id, projectId);
            TempData["SuccessMessage"] = "Translation deleted successfully!";
            return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId });
        }
    }
}




@using GoRegister.ApplicationCore.Domain.CustomFieldResource
@model GoRegister.ApplicationCore.Domain.CustomFieldResource.CustomFieldResourceViewModel

<h2>Custom Field Resource</h2>

<!-- ERROR MESSAGE (Inline Validation: duplicate, missing fields) -->
@if (!string.IsNullOrEmpty(Model.ValidationMessage))
{
    <div class="alert alert-danger">
        @Model.ValidationMessage
    </div>
}

<!-- SUCCESS MESSAGE (Redirect-based) -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

<form asp-action="AddCustomFieldMapping"
      asp-route-projectId="@Model.ProjectId"
      method="post">

    <input type="hidden" asp-for="ProjectId" />
    <input type="hidden" asp-for="MRFLanguageResourceId" />

    <div class="row">
        <div class="col-md-4">
            <label>Language Selection</label>
            <select asp-for="SelectedLanguageId"
                    asp-items="Model.Languages"
                    class="form-control"
                    disabled="@(Model.IsEditMode ? "disabled" : null)">
                <option value="">-- choose --</option>
            </select>
        </div>

        <div class="col-md-4">
            <label>Custom Field</label>
            <select asp-for="SelectedFieldId"
                    asp-items="Model.CustomFields"
                    class="form-control"
                    disabled="@(Model.IsEditMode ? "disabled" : null)">
                <option value="">-- choose --</option>
            </select>
        </div>

        <div class="col-md-4">
            <label>Language Resource</label>
            <input asp-for="LanguageResourceText" class="form-control" />
        </div>
    </div>

    <div class="col-md-2 mt-2">
        <label>Active</label>
        <select asp-for="IsActive" class="form-control"
                disabled="@(Model.IsEditMode ? null : "disabled")">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
        </select>
    </div>

    <button class="btn btn-success mt-3" id="save">
        @(Model.IsEditMode ? "Update" : "Save")
    </button>
</form>

<hr />

<h3>Language Resource Details</h3>

<table class="table table-hover table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Language</th>
            <th>Custom Field</th>
            <th>Resource</th>
            <th>Status</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var item in Model.ExistingResources)
        {
            <tr>
                <td>@item.LanguageName</td>
                <td>@item.FieldName</td>
                <td>@item.ResourceText</td>
                <td>@(item.IsActive ? "Active" : "Inactive")</td>
                <td>
                    <form asp-action="Edit"
                          asp-route-id="@item.Id"
                          asp-route-projectId="@Model.ProjectId"
                          method="get">
                        <button class="btn btn-primary btn-sm">Edit</button>
                    </form>
                </td>
                <td>
                    <form asp-action="Delete"
                          asp-route-id="@item.Id"
                          asp-route-projectId="@Model.ProjectId"
                          method="post">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

using GoRegister.ApplicationCore.Domain.CustomFieldResource;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.ApplicationCore.Domain.Clients;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.CustomFieldMapping
{
    [Area("Admin")]
    [Route("admin/project/{projectId:int}/customfieldmapping")]
    public class CustomFieldMappingController : Controller
    {
        private readonly ICustomFieldResourceCacheService _service;

        public CustomFieldMappingController(
            ICustomFieldResourceCacheService service)
        {
            _service = service;
        }

        // LOAD PAGE
        [HttpGet("")]
        public async Task<IActionResult> AddCustomFieldMapping(int projectId)
        {
            var vm = await _service.LoadPageAsync(projectId);
            return View(vm);
        }

        // SAVE (INSERT / UPDATE)
        [HttpPost("")]
        public async Task<IActionResult> AddCustomFieldMapping(
            [FromForm] CustomFieldResourceViewModel vm,
            int projectId)
        {
            // Required fields check
            if (vm.SelectedLanguageId == 0 ||
                vm.SelectedFieldId == 0 ||
                string.IsNullOrWhiteSpace(vm.LanguageResourceText))
            {
                vm.ValidationMessage = "All fields are required.";
                vm = await _service.ReloadPageWithSelectionsAsync(vm);
                return View(vm);
            }

            // INSERT MODE
            if (!vm.MRFLanguageResourceId.HasValue)
            {
                var exists = await _service.ExistsAsync(projectId,
                                                        vm.SelectedLanguageId,
                                                        vm.SelectedFieldId);

                if (exists)
                {
                    vm.ValidationMessage = "A resource already exists for this Language + Custom Field.";
                    vm = await _service.ReloadPageWithSelectionsAsync(vm);
                    return View(vm);
                }

                await _service.SaveAsync(vm);
                TempData["SuccessMessage"] = "Translation added successfully!";
            }
            else
            {
                // UPDATE MODE
                await _service.UpdateAsync(vm);
                TempData["SuccessMessage"] = "Translation updated successfully!";
            }

            return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId });
        }

        // EDIT
        [HttpGet("edit/{id:int}")]
        public async Task<IActionResult> Edit(int id, int projectId)
        {
            var vm = await _service.LoadPageAsync(projectId);
            var editItem = await _service.LoadForEditAsync(id, projectId);

            vm.MRFLanguageResourceId = editItem.MRFLanguageResourceId;
            vm.SelectedLanguageId = editItem.SelectedLanguageId;
            vm.SelectedFieldId = editItem.SelectedFieldId;
            vm.LanguageResourceText = editItem.LanguageResourceText;
            vm.DataTag = editItem.DataTag;
            vm.IsActive = editItem.IsActive;

            return View(nameof(AddCustomFieldMapping), vm);
        }

        // SOFT DELETE
        [HttpPost("delete/{id:int}")]
        public async Task<IActionResult> Delete(int id, int projectId)
        {
            await _service.DeleteAsync(id, projectId);
            TempData["SuccessMessage"] = "Translation deleted successfully!";
            return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId });
        }
    }
}




*************************************************************************************************

public async Task<bool> ExistsAsync(int projectId, int languageId, int fieldId)
{
    return await (
        from mr in _db.MRFLanguageResource
        join lr in _db.LanguageResource on mr.LanguageResourceId equals lr.Id
        where mr.ProjectId == projectId
              && mr.FieldId == fieldId
              && lr.LanguageId == languageId
              && lr.IsActive
        select mr.Id
    ).AnyAsync();
}

public async Task<(bool Success, string Error)> TrySaveAsync(CustomFieldResourceViewModel vm)
{
    bool exists = await ExistsAsync(vm.ProjectId, vm.SelectedLanguageId, vm.SelectedFieldId);

    if (exists)
        return (false, "A resource already exists for this Language and Custom Field.");

    await SaveAsync(vm); // your existing insert logic

    return (true, null);
}


[HttpPost]
public async Task<IActionResult> AddCustomFieldMapping([FromForm] CustomFieldResourceViewModel vm)
{
    // Validation
    if (vm.SelectedLanguageId == 0 || vm.SelectedFieldId == 0 || string.IsNullOrWhiteSpace(vm.LanguageResourceText))
    {
        vm.ValidationMessage = "All fields are required.";
        vm = await _customFieldMappingService.ReloadPageWithSelectionsAsync(vm);
        return View(vm);
    }

    // CREATE MODE
    if (!vm.MRFLanguageResourceId.HasValue)
    {
        var result = await _customFieldMappingService.TrySaveAsync(vm);

        if (!result.Success)
        {
            vm.ValidationMessage = result.Error;

            // Reload page + keep dropdowns selected
            vm = await _customFieldMappingService.ReloadPageWithSelectionsAsync(vm);

            return View(vm); // show same page with error
        }
    }
    else
    {
        // UPDATE MODE (still allowed)
        await _customFieldMappingService.UpdateAsync(vm);
    }

    return RedirectToAction(nameof(AddCustomFieldMapping), new { projectId = vm.ProjectId });
}

public async Task<CustomFieldResourceViewModel> ReloadPageWithSelectionsAsync(CustomFieldResourceViewModel vm)
{
    var page = await LoadPageAsync(vm.ProjectId);

    // Keep user's selected values
    page.MRFLanguageResourceId = vm.MRFLanguageResourceId;
    page.SelectedLanguageId    = vm.SelectedLanguageId;
    page.SelectedFieldId       = vm.SelectedFieldId;
    page.LanguageResourceText  = vm.LanguageResourceText;
    page.ValidationMessage     = vm.ValidationMessage;

    return page;
}


@if (Model.HasError)
{
    <div class="alert alert-danger">
        @Model.ValidationMessage
    </div>
}

@if (!string.IsNullOrEmpty(Model.ValidationMessage))
{
    <div class="alert alert-danger">
        @Model.ValidationMessage
    </div>
}



###########################################################################################333333

using GoRegister.ApplicationCore.Data.Models;
using GoRegister.ApplicationCore.Domain.Clients;
using GoRegister.ApplicationCore.Domain.Projects.Services;
using GoRegister.ApplicationCore.Domain.CustomFieldResource;
using GoRegister.ApplicationCore.Domain.Settings.Models;
using GoRegister.ApplicationCore.Domain.Settings.Services;
using GoRegister.Areas.Admin.Controllers;
using Microsoft.AspNetCore.Mvc;
using Microsoft.CodeAnalysis;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;

namespace GoRegister.Areas.Admin.Features.CustomFieldMapping
{
	public class CustomFieldMappingController : ProjectAdminControllerBase
	{
		private readonly IProjectService _projectService;
		private readonly ISettingsService _settingsService;
		private readonly IClientService _clientservice;
		private readonly ICustomFieldResourceCacheService _customFieldMappingService;

		public static int ProjectId { get; set; }
		public static string ClientUuid { get; set; }
		public static int UserId { get; set; }
		public static string AddEdit { get; set; }
		public CustomFieldMappingController(ICustomFieldResourceCacheService languageMappingService, IProjectService projectService, ISettingsService settingsService, IClientService clientService)
		{
			_customFieldMappingService = languageMappingService;
			_projectService = projectService;
			_settingsService = settingsService;
			_clientservice = clientService;
		}

		[HttpGet]
		public async Task<IActionResult> AddCustomFieldMapping(int projectId)
		{
			var vm = await _customFieldMappingService.LoadPageAsync(projectId);
			return View(vm);
		}

		[HttpPost]
		public async Task<IActionResult> AddCustomFieldMapping([FromForm] CustomFieldResourceViewModel vm)
		{
			if (vm.SelectedLanguageId != 0 && vm.SelectedFieldId != 0 && !string.IsNullOrWhiteSpace(vm.LanguageResourceText))
			{
				if (vm.MRFLanguageResourceId.HasValue)
				{
					await _customFieldMappingService.UpdateAsync(vm);  // EDIT MODE
				}
				else
				{
					await _customFieldMappingService.SaveAsync(vm);    // CREATE MODE
				}
			}
			return RedirectToAction(nameof(AddCustomFieldMapping));
		}

		[HttpPost("delete")]
		public async Task<IActionResult> Delete(int id, int projectId)
		{
			await _customFieldMappingService.DeleteAsync(id, projectId);
			return RedirectToAction(nameof(AddCustomFieldMapping));
		}

		[HttpGet("edit")]
		public async Task<IActionResult> Edit(int id, int projectId)
		{
			var vm = await _customFieldMappingService.LoadPageAsync(projectId);

			var editItem = await _customFieldMappingService.LoadForEditAsync(id, projectId);

			vm.MRFLanguageResourceId = editItem.MRFLanguageResourceId;
			vm.SelectedLanguageId = editItem.SelectedLanguageId;
			vm.SelectedFieldId = editItem.SelectedFieldId;
			vm.LanguageResourceText = editItem.LanguageResourceText;
			vm.DataTag = editItem.DataTag;

			return View(nameof(AddCustomFieldMapping), vm);
		}
	}
}

***********************

@using GoRegister.ApplicationCore.Domain.CustomFieldResource
@model GoRegister.ApplicationCore.Domain.CustomFieldResource.CustomFieldResourceViewModel
<h2>Custom Field Resource</h2>

@* @using (Html.BeginForm())
{ *@

<form method="post">
	<input type="hidden" asp-for="ProjectId" />
	<input type="hidden" asp-for="MRFLanguageResourceId" />

	<div class="row">
		<div class="col-md-4">
			<label>Language Selection</label>
			<select asp-for="SelectedLanguageId" asp-items="Model.Languages" class="form-control" disabled="@(Model.IsEditMode ? "disabled" : null)">
				<option value="">-- choose --</option>
			</select>
		</div>

		<div class="col-md-4">
			<label>Custom Field</label>
			<select asp-for="SelectedFieldId" asp-items="Model.CustomFields" class="form-control" disabled="@(Model.IsEditMode ? "disabled" : null)">
				<option value="">-- choose --</option>
			</select>
		</div>

		<div class="col-md-4">
			<label>Language Resource</label>
			<input asp-for="LanguageResourceText" class="form-control" />
		</div>
	</div>

	<button class="btn btn-success mt-3" id="save">
		@(Model.IsEditMode ? "Update" : "Save")
	</button>

</form>

<hr />

<h3>Language Resource Details</h3>

<table class="table table-hover table-bordered">
	<thead class="table-dark">
		<tr>
			<th>Language</th>
			<th>Custom Field</th>
			<th>Resource</th>
			<th>Edit</th>
			<th>Delete</th>
		</tr>
	</thead>

	<tbody>
		@foreach (var item in Model.ExistingResources)
		{
			<tr>
				<td>@item.LanguageName</td>
				<td>@item.FieldName</td>
				<td>@item.ResourceText</td>
				<td>
					<form asp-action="Edit" asp-route-id="@item.Id" asp-route-projectId="@Model.ProjectId" method="get">
						<button class="btn btn-primary btn-sm">Edit</button>
					</form>
				</td>
				<td>
					<form asp-action="Delete" asp-route-id="@item.Id" asp-route-projectId="@Model.ProjectId" method="post">
						<button class="btn btn-danger btn-sm">Delete</button>
					</form>
				</td>
			</tr>
		}
	</tbody>
</table>

@section Scripts {
	<script>

		$(function () {
			$("#save").click(function () {
				var dt = $('#SelectedLanguageId').val();
				var field = $('#SelectedFieldId').val();
				if (dt == '') {
					$('#smsg').text('Please select a language.');
					return;
				} else {
					$('#smsg').text('');
				}
			});
		});

	</script>
}


<select asp-for="SelectedLanguageId"
        asp-items="Model.Languages"
        class="form-control"
        @(Model.IsEditMode ? "disabled" : "")>
</select>

<select asp-for="SelectedFieldId"
        asp-items="Model.CustomFields"
        class="form-control"
        @(Model.IsEditMode ? "disabled" : "")>
</select>



public class EditCustomFieldResourceViewModel
{
    public int ProjectId { get; set; }
    public int MRFLanguageResourceId { get; set; }   // PK of MRFLanguageResource

    public int SelectedLanguageId { get; set; }
    public int SelectedFieldId { get; set; }

    public string LanguageResourceText { get; set; }
    public string DataTag { get; set; }

    public List<SelectListItem> Languages { get; set; } = new();
    public List<SelectListItem> CustomFields { get; set; } = new();
}



public async Task<EditCustomFieldResourceViewModel> LoadForEditAsync(int id, int projectId)
{
    // Load MRFLanguageResource + LanguageResource + Field
    var record = await (
        from mr in _db.MRFLanguageResource
        join lr in _db.LanguageResource on mr.LanguageResourceId equals lr.Id
        join f in _db.Fields on mr.FieldId equals f.Id
        where mr.Id == id && mr.ProjectId == projectId
        select new
        {
            MRFLRId = mr.Id,
            lr.LanguageId,
            lr.LanguageResourceText,
            FieldId = f.Id,
            f.DataTag
        }
    ).FirstOrDefaultAsync();

    if (record == null)
        throw new Exception("Custom field translation not found.");

    var vm = new EditCustomFieldResourceViewModel
    {
        ProjectId = projectId,
        MRFLanguageResourceId = record.MRFLRId,
        SelectedLanguageId = record.LanguageId,
        SelectedFieldId = record.FieldId,
        LanguageResourceText = record.LanguageResourceText,
        DataTag = record.DataTag
    };

    // --------------------------------------------------
    // 1️⃣ Load languages mapped to this project
    // --------------------------------------------------
    vm.Languages = await (
        from ml in _db.MRFLanguage
        join l in _db.Language on ml.LanguageId equals l.Id
        where ml.ProjectId == projectId
        orderby l.SortOrder
        select new SelectListItem
        {
            Value = l.Id.ToString(),
            Text = l.LanguageName
        }
    ).ToListAsync();

    // --------------------------------------------------
    // 2️⃣ Load all custom fields for this project
    // --------------------------------------------------
    vm.CustomFields = await _db.Fields
        .Where(f => f.ProjectId == projectId && f.IsStandardField == null)
        .OrderBy(f => f.SortOrder)
        .Select(f => new SelectListItem
        {
            Value = f.Id.ToString(),
            Text = f.FieldName ?? f.DataTag
        })
        .ToListAsync();

    return vm;
}







[HttpGet("edit/{id:int}")]
public async Task<IActionResult> Edit(int id, int projectId)
{
    var vm = await _service.LoadPageAsync(projectId);

    // Load edit data into same VM
    var editItem = await _service.LoadForEditAsync(id, projectId);

    vm.MRFLanguageResourceId = editItem.MRFLanguageResourceId;
    vm.SelectedLanguageId = editItem.SelectedLanguageId;
    vm.SelectedFieldId = editItem.SelectedFieldId;
    vm.LanguageResourceText = editItem.LanguageResourceText;
    vm.DataTag = editItem.DataTag;

    return View("Index", vm);
}


[HttpPost("save")]
public async Task<IActionResult> Save(CustomFieldResourceViewModel vm)
{
    if (vm.MRFLanguageResourceId.HasValue)
    {
        await _service.UpdateAsync(vm);  // EDIT MODE
    }
    else
    {
        await _service.SaveAsync(vm);    // CREATE MODE
    }

    return RedirectToAction("Index", new { projectId = vm.ProjectId });
}


public async Task UpdateAsync(CustomFieldResourceViewModel vm)
{
    var mr = await _db.MRFLanguageResource
        .FirstAsync(x => x.Id == vm.MRFLanguageResourceId);

    var lr = await _db.LanguageResource
        .FirstAsync(x => x.Id == mr.LanguageResourceId);

    // Update LanguageResource
    lr.LanguageId = vm.SelectedLanguageId;
    lr.LanguageResourceText = vm.LanguageResourceText;

    // Update DataTag based on selected field
    var field = await _db.Fields.FirstAsync(f => f.Id == vm.SelectedFieldId);
    lr.DataTag = field.DataTag;

    // Update MRFLanguageResource
    mr.FieldId = vm.SelectedFieldId;

    await _db.SaveChangesAsync();
}


<button class="btn btn-success mt-3">
    @(Model.IsEditMode ? "Update" : "Save")
</button>

<input type="hidden" asp-for="MRFLanguageResourceId" />
<a asp-action="Edit"
   asp-route-projectId="@Model.ProjectId"
   asp-route-id="@item.Id"
   class="btn btn-primary btn-sm">
   Edit
</a>







using Microsoft.AspNetCore.Mvc;
using YourApp.ViewModels;

namespace GoRegister.Features.Admin
{
    [Route("admin/project/{projectId:int}/customfields")]
    public class CustomFieldResourceController : Controller
    {
        private readonly ICustomFieldResourceService _service;

        public CustomFieldResourceController(ICustomFieldResourceService service)
        {
            _service = service;
        }

        [HttpGet("")]
        public async Task<IActionResult> Index(int projectId)
        {
            var vm = await _service.LoadPageAsync(projectId);
            return View(vm);
        }

        [HttpPost("save")]
        public async Task<IActionResult> Save(CustomFieldResourceViewModel vm)
        {
            await _service.SaveAsync(vm);
            return RedirectToAction("Index", new { projectId = vm.ProjectId });
        }

        [HttpPost("delete/{id:int}")]
        public async Task<IActionResult> Delete(int id, int projectId)
        {
            await _service.DeleteAsync(id, projectId);
            return RedirectToAction("Index", new { projectId });
        }
    }
}



@model CustomFieldResourceViewModel

<h2>Custom Field Resource</h2>

<form asp-action="Save" method="post">
    <input type="hidden" asp-for="ProjectId" />

    <div class="row">
        <div class="col-md-4">
            <label>Language Selection</label>
            <select asp-for="SelectedLanguageId" asp-items="Model.Languages" class="form-control">
                <option value="">-- choose --</option>
            </select>
        </div>

        <div class="col-md-4">
            <label>Custom Field</label>
            <select asp-for="SelectedFieldId" asp-items="Model.CustomFields" class="form-control">
                <option value="">-- choose --</option>
            </select>
        </div>

        <div class="col-md-4">
            <label>Language Resource</label>
            <input asp-for="LanguageResourceText" class="form-control" />
        </div>
    </div>

    <button class="btn btn-success mt-3">Save</button>
</form>

<hr />

<h3>Existing Resources</h3>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Language</th>
            <th>Custom Field</th>
            <th>Resource</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var item in Model.ExistingResources)
        {
            <tr>
                <td>@item.LanguageName</td>
                <td>@item.FieldName</td>
                <td>@item.ResourceText</td>
                <td>
                    <a class="btn btn-primary btn-sm" href="#">Edit</a> @* optional *@
                </td>
                <td>
                    <form asp-action="Delete" asp-route-id="@item.Id" asp-route-projectId="@Model.ProjectId" method="post">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>





public class CustomFieldResourceViewModel
{
    public int ProjectId { get; set; }

    public int SelectedLanguageId { get; set; }
    public int SelectedFieldId { get; set; }
    public string LanguageResourceText { get; set; }

    public List<SelectListItem> Languages { get; set; } = new();
    public List<SelectListItem> CustomFields { get; set; } = new();

    // For listing existing mappings
    public List<CustomFieldResourceListItem> ExistingResources { get; set; } = new();

    public class CustomFieldResourceListItem
    {
        public int Id { get; set; }                  // MRFLanguageResource.Id
        public string LanguageName { get; set; }
        public string FieldName { get; set; }
        public string ResourceText { get; set; }
    }
}





using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Mvc.Rendering;
using YourApp.ViewModels;
using GoRegister.ApplicationCore.Data;

public class CustomFieldResourceService : ICustomFieldResourceService
{
    private readonly ApplicationDbContext _db;

    public CustomFieldResourceService(ApplicationDbContext db)
    {
        _db = db;
    }

    // ------------------------------------------------------
    // LOAD PAGE DATA (Languages, Fields, Existing Resources)
    // ------------------------------------------------------
    public async Task<CustomFieldResourceViewModel> LoadPageAsync(int projectId)
    {
        var vm = new CustomFieldResourceViewModel
        {
            ProjectId = projectId
        };

        // 1. Languages mapped to this project (MRFLanguage)
        vm.Languages = await (
            from ml in _db.MRFLanguage
            join l in _db.Language on ml.LanguageId equals l.Id
            where ml.ProjectId == projectId
            orderby l.SortOrder
            select new SelectListItem
            {
                Value = l.Id.ToString(),
                Text = l.LanguageName
            }
        ).ToListAsync();


        // 2. Custom Fields (where IsStandardField == null)
        vm.CustomFields = await _db.Fields
            .Where(f => f.ProjectId == projectId && f.IsStandardField == null)
            .OrderBy(f => f.SortOrder)
            .Select(f => new SelectListItem
            {
                Value = f.Id.ToString(),
                Text = f.FieldName ?? f.DataTag
            })
            .ToListAsync();


        // 3. Existing Translations
        vm.ExistingResources = await (
            from mr in _db.MRFLanguageResource
            join lr in _db.LanguageResource on mr.LanguageResourceId equals lr.Id
            join f in _db.Fields on mr.FieldId equals f.Id
            join l in _db.Language on lr.LanguageId equals l.Id
            where mr.ProjectId == projectId
            select new CustomFieldResourceViewModel.CustomFieldResourceListItem
            {
                Id = mr.Id,
                LanguageName = l.LanguageName,
                FieldName = f.FieldName ?? f.DataTag,
                ResourceText = lr.LanguageResourceText
            }
        ).ToListAsync();

        return vm;
    }

    // ------------------------------------------------------
    // SAVE A NEW RESOURCE
    // ------------------------------------------------------
    public async Task SaveAsync(CustomFieldResourceViewModel vm)
    {
        // Save into LanguageResource
        var lr = new LanguageResource
        {
            LanguageId = vm.SelectedLanguageId,
            LanguageResourceText = vm.LanguageResourceText,
            ProjectId = vm.ProjectId,
            StandardField = false
        };

        _db.LanguageResource.Add(lr);
        await _db.SaveChangesAsync();

        // Link to MRFLanguageResource
        var mrlr = new MRFLanguageResource
        {
            ProjectId = vm.ProjectId,
            FieldId = vm.SelectedFieldId,
            LanguageResourceId = lr.Id
        };

        _db.MRFLanguageResource.Add(mrlr);
        await _db.SaveChangesAsync();
    }

    // ------------------------------------------------------
    // DELETE RESOURCE (remove both tables)
    // ------------------------------------------------------
    public async Task DeleteAsync(int id, int projectId)
    {
        var mr = await _db.MRFLanguageResource.FindAsync(id);

        if (mr != null)
        {
            var lr = await _db.LanguageResource.FindAsync(mr.LanguageResourceId);
            if (lr != null) _db.LanguageResource.Remove(lr);

            _db.MRFLanguageResource.Remove(mr);
            await _db.SaveChangesAsync();
        }
    }
}








public async Task<Dictionary<string, string>> GetLabelMapForLanguageAsync(int projectId, string languageCode)
{
    var rows = await (
        from l in _db.Language
        join mrl in _db.MRFLanguage on l.Id equals mrl.LanguageId
        join lr in _db.LanguageResource on new { mrl.ProjectId, mrl.LanguageId } 
                                           equals new { lr.ProjectId, lr.LanguageId }
        join mrflr in _db.MRFLanguageResource on lr.Id equals mrflr.LanguageResourceId
        join f in _db.Fields on mrflr.FieldId equals f.Id
        where mrl.ProjectId == projectId
           && l.LanguageCode.ToLower() == languageCode.ToLower()
        select new
        {
            FieldKey = f.Id.ToString(),
            Label = lr.LanguageResourceText
        }
    ).ToListAsync();

    return rows
        .GroupBy(x => x.FieldKey)
        .ToDictionary(g => g.Key, g => g.First().Label);
}


public async Task<Dictionary<string, string>> GetLabelMapForLanguageAsync(int projectId, string languageCode)
{
    var rows = await (
        from lr in _db.LanguageResource
		join l in _db.Language on lr.LanguageId equals l.Id
        join mrflr in _db.MRFLanguageResource on lr.Id equals mrflr.LanguageResourceId
		join f in _db.Fields on mrflr.FieldId equals f.Id
		where l.LanguageCode.ToLower() == languageCode.ToLower() && lr.ProjectId == projectId
		select new
        {
            FieldKey = f.Id.ToString(), 
            Label = lr.LanguageResourceText                    
        }
    ).ToListAsync();

    var map = rows
        .GroupBy(x => x.FieldKey)
        .ToDictionary(g => g.Key, g => g.First().Label);

    return map;
}

SELECT * FROM LANGUAGE
SELECT * FROM MRFLANGUAGE
SELECT * FROM LANGUAGERESOURCE
SELECT * FROM MRFLANGUAGERESOURCE

7	English	en	1	1
8	Spanish	es	1	2
9	French	fr	1	3

1	112	8
2	112	9
3	112	7

1	*Event Start Date 	9	1	112	EventStartDate
2	*Event End Date 	9	1	112	EventEndDate
3	*Contact email address	9	1	112	Email
4	*Destination 	9	1	112	DestinationExternalId
5	*Requestor Country	9	1	112	RequestorCountry
6	*Servicing Country	9	1	112	ServicingCountry
7	*Contact First Name	9	1	112	FirstName
8	*Contact Last Name	9	1	112	LastName
9	*Are your dates or destination flexible? 	9	1	112	Areyourdatesordestinationflexible?
10	Additional Information	9	1	112	AdditionalInformation
11	*Contact phone number	9	1	112	Contactphonenumber
12	Event Name 	9	1	112	EventName
13	*Number of Attendees 	9	1	112	NumberofAttendees

1	112	3167	1
2	112	3168	2
3	112	3169	3
4	112	3172	4
5	112	3173	5
6	112	3174	6
7	112	3175	7
8	112	3184	8
9	112	3187	9
10	112	3192	10
11	112	3194	11
12	112	3195	12
13	112	3196	13

=============================================================================================================================================


CREATE OR ALTER PROCEDURE dbo.ImportLanguageResources
(
      @LanguageCode NVARCHAR(10)     -- 'fr', 'es', or 'en'
    , @ExcelPath    NVARCHAR(4000)   -- Full file path
)
AS
BEGIN
    SET NOCOUNT ON;
    SET XACT_ABORT ON;

    DECLARE 
          @LanguageId INT
        , @ProjectId INT
        , @ResourceColumn NVARCHAR(50)
        , @sql NVARCHAR(MAX);

    PRINT 'Starting import for LanguageCode = ' + @LanguageCode;

    ------------------------------------------------------------
    -- 1. Validate & Look Up LanguageId
    ------------------------------------------------------------
    SELECT @LanguageId = Id 
    FROM Language 
    WHERE LanguageCode = @LanguageCode;

    IF @LanguageId IS NULL
    BEGIN
        RAISERROR('LanguageCode "%s" not found in Language table.', 16, 1, @LanguageCode);
        RETURN;
    END

    ------------------------------------------------------------
    -- 2. Look up ProjectId for this language
    -- A language can be used in multiple projects, but here we
    -- pick the first one. Adjust if needed.
    ------------------------------------------------------------
    SELECT TOP 1 @ProjectId = ProjectId 
    FROM MRFLANGUAGE
    WHERE LanguageId = @LanguageId;

    IF @ProjectId IS NULL
    BEGIN
        RAISERROR('No MRFLANGUAGE record found for LanguageId %d.', 16, 1, @LanguageId);
        RETURN;
    END

    ------------------------------------------------------------
    -- 3. Determine which column to read from Excel
    ------------------------------------------------------------
    IF (@LanguageCode = 'fr')      SET @ResourceColumn = 'French';
    ELSE IF (@LanguageCode = 'es') SET @ResourceColumn = 'Spanish';
    ELSE IF (@LanguageCode = 'en') SET @ResourceColumn = 'FieldName';
    ELSE
    BEGIN
        RAISERROR('Unsupported LanguageCode "%s".', 16, 1, @LanguageCode);
        RETURN;
    END

    ------------------------------------------------------------
    -- 4. Load Excel → #ExcelResources using OPENROWSET
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#ExcelResources') IS NOT NULL DROP TABLE #ExcelResources;

    DECLARE @OpenRowset NVARCHAR(MAX) = '
        SELECT *
        FROM OPENROWSET(
            ''Microsoft.ACE.OLEDB.12.0'',
            ''Excel 12.0;HDR=YES;Database=' + @ExcelPath + ''',
            ''SELECT * FROM [Sheet1$]''
        )';

    CREATE TABLE #ExcelResources
    (
          FieldId INT
        , DataTag NVARCHAR(200)
        , French NVARCHAR(4000) NULL
        , Spanish NVARCHAR(4000) NULL
        , FieldName NVARCHAR(4000) NULL
    );

    INSERT INTO #ExcelResources
    EXEC(@OpenRowset);

    PRINT 'Excel loaded successfully.';

    ------------------------------------------------------------
    -- 5. Prepare #ToInsert (created OUTSIDE dynamic SQL)
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#ToInsert') IS NOT NULL DROP TABLE #ToInsert;

    CREATE TABLE #ToInsert
    (
          RowNum INT
        , FieldId INT
        , ResourceText NVARCHAR(4000)
        , DataTag NVARCHAR(200)
    );

    ------------------------------------------------------------
    -- 6. Insert rows into #ToInsert via dynamic SQL
    -- This works because table exists *before* EXEC.
    ------------------------------------------------------------
    SET @sql = N'
        INSERT INTO #ToInsert (RowNum, FieldId, ResourceText, DataTag)
        SELECT
              ROW_NUMBER() OVER (ORDER BY FieldId) AS RowNum
            , FieldId
            , ' + QUOTENAME(@ResourceColumn) + N' AS ResourceText
            , DataTag
        FROM #ExcelResources
        WHERE ' + QUOTENAME(@ResourceColumn) + N' IS NOT NULL
          AND LTRIM(RTRIM(' + QUOTENAME(@ResourceColumn) + N')) <> ''''
    ';

    EXEC(@sql);

    PRINT 'Rows staged into #ToInsert.';

    ------------------------------------------------------------
    -- 7. Prepare #InsertedResources to capture mapping
    ------------------------------------------------------------
    IF OBJECT_ID('tempdb..#InsertedResources') IS NOT NULL DROP TABLE #InsertedResources;

    CREATE TABLE #InsertedResources
    (
          RowNum INT
        , LanguageResourceId INT
    );

    ------------------------------------------------------------
    -- 8. MERGE to insert into LanguageResource and capture IDs
    ------------------------------------------------------------
    MERGE INTO LanguageResource AS T
    USING (
        SELECT
              RowNum
            , ResourceText
            , @LanguageId AS LanguageId
            , 1 AS StandardField
            , @ProjectId AS ProjectId
            , DataTag
        FROM #ToInsert
    ) AS SRC
        ON 1 = 0   -- Always insert
    WHEN NOT MATCHED THEN
        INSERT (LanguageResourceText, LanguageId, StandardField, ProjectId, DataTag)
        VALUES (SRC.ResourceText, SRC.LanguageId, SRC.StandardField, SRC.ProjectId, SRC.DataTag)
    OUTPUT 
          SRC.RowNum
        , INSERTED.Id
    INTO #InsertedResources (RowNum, LanguageResourceId);

    PRINT 'Inserted into LanguageResource.';

    ------------------------------------------------------------
    -- 9. Insert into MRFLanguageResource (Field ↔ Resource)
    ------------------------------------------------------------
    INSERT INTO MRFLanguageResource (ProjectId, FieldId, LanguageResourceId)
    SELECT
          @ProjectId
        , T.FieldId
        , IR.LanguageResourceId
    FROM #ToInsert AS T
    JOIN #InsertedResources AS IR
        ON T.RowNum = IR.RowNum;

    PRINT 'Linked fields to LanguageResource';

    ------------------------------------------------------------
    -- 10. Cleanup
    ------------------------------------------------------------
    DROP TABLE #InsertedResources;
    DROP TABLE #ToInsert;
    DROP TABLE #ExcelResources;

    PRINT 'Import completed successfully for ' + @LanguageCode;

END
GO




************************************************************************************************************************************************






------------------------------------------------------------
-- 1) Ensure language master rows exist
------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @EsCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@EsCode, N'Spanish');

IF NOT EXISTS (SELECT 1 FROM LANGUAGE WHERE LanguageCode = @FrCode)
    INSERT INTO LANGUAGE (LanguageCode, LanguageName)
    VALUES (@FrCode, N'French');

------------------------------------------------------------
-- 2) Enable languages for the project (MRFLANGUAGE uses LanguageId)
------------------------------------------------------------
IF OBJECT_ID('dbo.MRFLANGUAGE', 'U') IS NOT NULL
BEGIN
    -- Enable Spanish
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @EsCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );

    -- Enable French
    INSERT INTO MRFLANGUAGE (ProjectId, LanguageId)
    SELECT @ProjectId, L.Id
    FROM LANGUAGE L
    WHERE L.LanguageCode = @FrCode
      AND NOT EXISTS (
            SELECT 1
            FROM MRFLANGUAGE ML
            WHERE ML.ProjectId = @ProjectId
              AND ML.LanguageId = L.Id
      );
END



*******************************************************************************/* ======= CONFIG ======= */
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx';
DECLARE @Sheet     NVARCHAR(128)  = N'Sheet1$'; -- change if needed

/* ======= Prep: enable OPENROWSET if needed ======= */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* ======= Stage Excel ======= */
IF OBJECT_ID('tempdb..#xl_raw') IS NOT NULL DROP TABLE #xl_raw;
CREATE TABLE #xl_raw
(
  ProjectId INT           NOT NULL,
  FieldId   INT           NOT NULL,
  EsText    NVARCHAR(4000) NULL,
  FrText    NVARCHAR(4000) NULL
);

INSERT INTO #xl_raw(ProjectId, FieldId, EsText, FrText)
SELECT
  CAST([ProjectId] AS INT) AS ProjectId,
  CAST([FieldId]   AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [ProjectId],[FieldId],[es],[fr] FROM [' + @Sheet + ']'
) AS X;

-- De-dup per ProjectId+FieldId (take the longest non-null value if duplicates)
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
SELECT
  ProjectId,
  FieldId,
  EsText = (SELECT TOP(1) v FROM (SELECT EsText v UNION ALL SELECT EsText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC),
  FrText = (SELECT TOP(1) v FROM (SELECT FrText v UNION ALL SELECT FrText) d WHERE v IS NOT NULL ORDER BY LEN(v) DESC)
INTO #xl
FROM #xl_raw
GROUP BY ProjectId, FieldId;

/* ======= Resolve language ids ======= */
DECLARE @EsLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'es', N'es-ES') ORDER BY CASE WHEN LanguageCode=N'es' THEN 0 ELSE 1 END);
DECLARE @FrLangId INT =
  (SELECT TOP(1) Id FROM LANGUAGE WHERE LanguageCode IN (N'fr', N'fr-FR') ORDER BY CASE WHEN LanguageCode=N'fr' THEN 0 ELSE 1 END);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish (es/es-ES) or French (fr/fr-FR) missing in LANGUAGE.', 16, 1);
  RETURN;
END

/* ======= Ensure MRFLANGUAGE rows exist for ALL ProjectIds in the sheet ======= */
-- Spanish
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @EsLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @EsLangId
);

-- French
INSERT INTO MRFLANGUAGE(ProjectId, LanguageId)
SELECT DISTINCT x.ProjectId, @FrLangId
FROM #xl x
WHERE NOT EXISTS (
  SELECT 1 FROM MRFLANGUAGE ml
  WHERE ml.ProjectId = x.ProjectId AND ml.LanguageId = @FrLangId
);

/* ======= UPSERT Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.EsText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @EsLangId
  WHERE x.EsText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

/* ======= UPSERT French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT
    ml.Id AS MRFLanguageId,
    x.FieldId,
    x.FrText AS LanguageResource
  FROM #xl x
  JOIN MRFLANGUAGE ml
    ON ml.ProjectId  = x.ProjectId
   AND ml.LanguageId = @FrLangId
  WHERE x.FrText IS NOT NULL
) AS S
ON  T.MRFLanguageId = S.MRFLanguageId
AND T.FieldId       = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)),N'') <> S.LanguageResource
  THEN UPDATE SET T.LanguageResource = S.LanguageResource
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (S.MRFLanguageId, S.FieldId, S.LanguageResource);

############################################################################################

/* ======= CONFIG ======= */
DECLARE @ProjectId INT = 123;  -- <-- set your project
DECLARE @ExcelPath NVARCHAR(4000) = N'C:\Imports\translations.xlsx'; -- full path
DECLARE @Sheet NVARCHAR(128) = N'Sheet1$';  -- worksheet name with trailing $

/* ======= Setup (OPENROWSET) ======= */
/* Require: ACE OLE DB and Ad Hoc Distributed Queries enabled */
IF NOT EXISTS (SELECT 1 FROM sys.configurations WHERE name = 'Ad Hoc Distributed Queries' AND value_in_use = 1)
BEGIN
  EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
  EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;
END

/* Temp staging */
IF OBJECT_ID('tempdb..#xl') IS NOT NULL DROP TABLE #xl;
CREATE TABLE #xl
(
  FieldId INT NOT NULL,
  EsText NVARCHAR(4000) NULL,
  FrText NVARCHAR(4000) NULL
);

/* Read Excel into #xl */
INSERT INTO #xl(FieldId, EsText, FrText)
SELECT
  CAST([FieldId] AS INT) AS FieldId,
  NULLIF(LTRIM(RTRIM([es])), N'') AS EsText,
  NULLIF(LTRIM(RTRIM([fr])), N'') AS FrText
FROM OPENROWSET
(
  'Microsoft.ACE.OLEDB.12.0',
  'Excel 12.0;HDR=YES;IMEX=1;Database=' + @ExcelPath,
  'SELECT [FieldId], [es], [fr] FROM [' + @Sheet + ']'
) AS X;

/* Validate staging */
IF EXISTS (SELECT 1 FROM #xl WHERE FieldId IS NULL)
BEGIN
  RAISERROR('Staging contains NULL FieldId values. Fix the Excel file and retry.', 16, 1);
  RETURN;
END

/* ======= Resolve LanguageIds and MRFLanguageIds ======= */
DECLARE @EsLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'es', N'es-ES')
  ORDER BY CASE WHEN LanguageCode = N'es' THEN 0 ELSE 1 END
);
DECLARE @FrLangId INT =
(
  SELECT TOP(1) Id
  FROM LANGUAGE
  WHERE LanguageCode IN (N'fr', N'fr-FR')
  ORDER BY CASE WHEN LanguageCode = N'fr' THEN 0 ELSE 1 END
);

IF @EsLangId IS NULL OR @FrLangId IS NULL
BEGIN
  RAISERROR('Spanish or French not found in LANGUAGE table. Insert them first.', 16, 1);
  RETURN;
END

/* Ensure MRFLANGUAGE rows exist for this project */
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @EsLangId);
IF NOT EXISTS (SELECT 1 FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId)
  INSERT INTO MRFLANGUAGE(ProjectId, LanguageId) VALUES (@ProjectId, @FrLangId);

DECLARE @EsMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@EsLangId);
DECLARE @FrMRF INT = (SELECT Id FROM MRFLANGUAGE WHERE ProjectId=@ProjectId AND LanguageId=@FrLangId);

/* ======= Upsert Spanish ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, EsText
  FROM #xl
  WHERE EsText IS NOT NULL
) AS S
ON T.MRFLanguageId = @EsMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.EsText
  THEN UPDATE SET T.LanguageResource = S.EsText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@EsMRF, S.FieldId, S.EsText);

/* ======= Upsert French ======= */
MERGE dbo.MRFLanguageResource AS T
USING (
  SELECT FieldId, FrText
  FROM #xl
  WHERE FrText IS NOT NULL
) AS S
ON T.MRFLanguageId = @FrMRF AND T.FieldId = S.FieldId
WHEN MATCHED AND NULLIF(LTRIM(RTRIM(T.LanguageResource)), N'') <> S.FrText
  THEN UPDATE SET T.LanguageResource = S.FrText
WHEN NOT MATCHED BY TARGET
  THEN INSERT (MRFLanguageId, FieldId, LanguageResource)
       VALUES (@FrMRF, S.FieldId, S.FrText);


